<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Sprint Dashboard</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/images/favicon.svg}">
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.0/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/estilo.css}">
    <link rel="stylesheet" th:href="@{/css/dark-theme.css}">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { background-color: #f8f9fa; overflow-x: hidden; }
        .main-container { max-width: 1400px; margin: 0 auto; padding-bottom: 50px; }
        
        /* Notification Sidebar Styles */
        .notification-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background-color: #f8f9fa;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1050;
            transition: right 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e9ecef;
        }
        .notification-sidebar.open { right: 0; }
        .notification-sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #ffffff;
        }
        .notification-sidebar-header h5 { color: var(--bs-body-color); cursor: pointer; }
        .notification-sidebar-body { flex-grow: 1; padding: 1.5rem; overflow-y: auto; background-color: #f8f9fa; }
        .notification-item {
            background-color: transparent;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            transition: all 0.2s ease;
            color: #212529;
        }
        .notification-item:hover { background-color: rgba(0, 0, 0, 0.05); border-color: rgba(0, 0, 0, 0.2); }
        .notification-item.unread { background-color: rgba(13, 110, 253, 0.1); border-color: rgba(13, 110, 253, 0.2); }
        .notification-item.unread:hover { background-color: rgba(13, 110, 253, 0.15); border-color: rgba(13, 110, 253, 0.3); }
        .notification-icon {
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .notification-content { flex-grow: 1; }
        .notification-content h6 { font-size: 0.95rem; font-weight: 600; margin-bottom: 0.25rem; color: var(--bs-body-color); }
        .notification-content p { font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; }
        .notification-time { font-size: 0.75rem; color: #adb5bd; text-align: right; flex-shrink: 0; }
        
        /* HEADER */
        .sprint-header {
            background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #edf2f7;
        }

        /* KANBAN BOARD */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            align-items: start;
        }

        .kanban-column {
            background: #f1f5f9;
            border-radius: 12px;
            padding: 16px;
            min-height: 500px;
            border: 1px solid #e2e8f0;
        }

        .column-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #cbd5e1;
        }
        
        .col-title { font-weight: 700; color: #475569; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .col-count { background: #e2e8f0; color: #64748b; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; }

        /* Cores das colunas (Opcional, borda superior colorida) */
        .col-todo { border-top: 4px solid #94a3b8; }
        .col-progress { border-top: 4px solid #f59e0b; } /* Amarelo/Laranja */
        .col-testing { border-top: 4px solid #8b5cf6; } /* Roxo */
        .col-done { border-top: 4px solid #10b981; } /* Verde */

        /* USER STORY CARD */
        .story-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            border: 1px solid #e2e8f0;
            cursor: grab;
            transition: all 0.2s ease;
        }
        .story-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
        .story-card:active { cursor: grabbing; }

        .priority-badge { font-size: 0.65rem; font-weight: 700; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; }
        .prio-HIGH { background-color: #fee2e2; color: #ef4444; }
        .prio-MEDIUM { background-color: #ffedd5; color: #f97316; }
        .prio-LOW { background-color: #d1fae5; color: #10b981; }

        .assignee-avatar {
            width: 24px; height: 24px; border-radius: 50%; background: #e2e8f0; 
            font-size: 0.6rem; display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: #64748b;
        }

        .btn-back-custom {
            display: flex; align-items: center; justify-content: center;
            width: 42px; height: 42px; border-radius: 12px;
            color: #6c757d; transition: all 0.2s ease; text-decoration: none; margin-right: 8px;
        }
        .btn-back-custom:hover {
            background-color: #0d6efd; color: white;
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.25); transform: translateY(-1px);
        }
        
        /* Dragging visuals */
        .kanban-column.drag-over { background-color: #e2e8f0; border-style: dashed; }
        .story-card.dragging { opacity: 0.5; }

        /* Dark Theme overrides */
        body.dark-theme .kanban-column { background-color: #1e1e1e; border-color: #333; }
        body.dark-theme .sprint-header { background-color: #1e1e1e; border-color: #333; }
        body.dark-theme .story-card { background-color: #2c2c2c; border-color: #444; color: #e0e0e0; }
        body.dark-theme .story-card:hover { background-color: #333; }
        body.dark-theme .col-title { color: #a0aec0; }
        body.dark-theme .col-count { background-color: #333; color: #cbd5e1; }
    </style>
</head>
<body th:class="${teacher != null ? 'teacher-bg' : 'student-bg'}">

    <nav th:class="'d-flex justify-content-between align-items-center p-3 bg-white border-bottom sticky-top ' + (${teacher != null ? 'navbar-teacher' : 'navbar-student'})" style="z-index: 1000;">
        <div class="d-flex align-items-center gap-3">
            <a th:if="${teacher != null}" th:href="@{/view/teacher/home/{userId}(userId=${teacher.id})}" class="btn-back-custom" title="Voltar">
                <i data-lucide="arrow-left" style="width: 24px; height: 24px;"></i>
            </a>
            <a th:if="${student != null}" th:href="@{'/view/student/home/' + ${student.id} + '?tab=projects'}" class="btn-back-custom" title="Voltar">
                <i data-lucide="arrow-left" style="width: 24px; height: 24px;"></i>
            </a>
            <div th:class="'text-white p-2 rounded-3 shadow-sm ' + (${teacher != null ? 'bg-primary' : 'bg-success'})">
                <i data-lucide="target" style="width: 24px; height: 24px;"></i>
            </div>
            <div>
                <h5 class="mb-0 fw-bold" style="color: #2c3e50;">EduScrum</h5>
                <small class="text-muted">Sprint Dashboard</small>
            </div>
        </div>
        
        <div class="d-flex align-items-center gap-4">
            <div id="notificationBellContainer" class="position-relative cursor-pointer p-2 rounded-circle hover-bg-light" onclick="toggleNotificationSidebar()">
                <i id="notificationBellIcon" data-lucide="bell" class="text-secondary"></i>
                <span id="notificationCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem; display: none;">0</span>
            </div>
            <div class="vr text-muted opacity-25" style="height: 30px;"></div>
            <div class="dropdown">
                <a href="#" class="profile-trigger text-decoration-none d-flex align-items-center gap-3" data-bs-toggle="dropdown">
                    <div class="text-end d-none d-md-block">
                        <div class="profile-name fw-bold text-dark" th:text="${teacher != null ? teacher.name : student.name}">Utilizador</div>
                        <div class="profile-email small text-muted" th:text="${teacher != null ? teacher.email : student.email}">email@upt.pt</div>
                    </div>
                    <img th:if="${(teacher != null ? teacher.profileImage : student.profileImage) != null}" 
                         th:src="@{'/uploads/profile-images/' + ${teacher != null ? teacher.profileImage : student.profileImage}}" 
                         class="rounded-circle shadow-sm border" style="width: 42px; height: 42px; object-fit: cover;">
                    <div th:unless="${(teacher != null ? teacher.profileImage : student.profileImage) != null}" 
                         th:class="'profile-avatar ' + (${teacher != null ? 'bg-primary' : 'bg-success'}) + ' text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm'" 
                         style="width: 42px; height: 42px; font-size: 1.2rem;" 
                         th:text="${#strings.substring((teacher != null ? teacher.name : student.name),0,1)}">U</div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-3 mt-2">
                    <li><a class="dropdown-item py-2" href="#" data-bs-toggle="modal" th:data-bs-target="${teacher != null ? '#editProfileModal' : '#editStudentProfileModal'}"><i data-lucide="user" class="w-4 h-4 inline me-2 opacity-50"></i> Editar Perfil</a></li>
                    <li><a class="dropdown-item py-2" href="#" data-bs-toggle="modal" data-bs-target="#settingsModal"><i data-lucide="settings" class="w-4 h-4 inline me-2 opacity-50"></i> Configurações</a></li>
                    <li><hr class="dropdown-divider my-2"></li>
                    <li><a class="dropdown-item py-2 text-danger" th:href="@{/logout}"><i data-lucide="log-out" class="w-4 h-4 inline me-2 opacity-50"></i> Sair</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="notificationSidebar" class="notification-sidebar">
        <div class="notification-sidebar-header">
            <h5 class="fw-bold mb-0" onclick="toggleNotificationSidebar()">Notificações</h5>
            <button type="button" class="btn-close" aria-label="Close" onclick="toggleNotificationSidebar()"></button>
        </div>
        <div class="notification-sidebar-body">
            <div id="notificationsContainer">
                <div class="text-center text-muted mt-4" id="noNotifications" style="display: none;">
                    <i data-lucide="bell-off" class="w-8 h-8 mb-2"></i>
                    <p>Nenhuma notificação nova.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container main-container pt-4">

        <div class="sprint-header">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-3 mb-2">
                        <i data-lucide="target" class="text-primary w-6 h-6"></i>
                        <h2 class="fw-bold mb-0 text-dark" th:text="${sprint.name}">Sprint 2</h2>
                        <span class="badge rounded-pill px-3" 
                              th:classappend="${sprint.status.name() == 'CONCLUIDO' ? 'bg-success' : (sprint.status.name() == 'EM_CURSO' ? 'bg-warning text-dark' : 'bg-secondary')}"
                              th:text="${sprint.status}">IN PROGRESS</span>
                    </div>
                    <p class="text-muted mb-0 ps-1" th:text="${sprint.description}">Descrição da sprint...</p>
                </div>
                <div class="text-end">
                    <div class="mb-2">
                        <span class="text-muted small fw-bold"><i data-lucide="calendar" class="w-3 h-3 inline me-1"></i> <span th:text="${sprint.startDate} + ' - ' + ${sprint.endDate}">Datas</span></span>
                    </div>
                    <div class="d-flex gap-2 justify-content-end">
                        <button th:if="${student != null and sprint.status.name() != 'CONCLUIDO'}" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm btn-sm" data-bs-toggle="modal" data-bs-target="#newUserStoryModal">
                            <i data-lucide="plus" class="w-4 h-4 inline me-1"></i> Nova User Story
                        </button>
                        <button th:if="${canComplete and student != null and sprint.status.name() != 'CONCLUIDO'}" class="btn btn-success rounded-pill px-4 fw-bold shadow-sm btn-sm" data-bs-toggle="modal" data-bs-target="#completeSprintModal">
                            <i data-lucide="check-circle" class="w-4 h-4 inline me-1"></i> Concluir Sprint
                        </button>
                        <button th:if="${student != null and sprint.status.name() == 'CONCLUIDO'}" class="btn btn-warning rounded-pill px-4 fw-bold shadow-sm btn-sm" data-bs-toggle="modal" data-bs-target="#reopenSprintModal">
                            <i data-lucide="rotate-ccw" class="w-4 h-4 inline me-1"></i> Reabrir Sprint
                        </button>
                        <button th:if="${student != null}" class="btn btn-danger rounded-pill px-4 fw-bold shadow-sm btn-sm" data-bs-toggle="modal" data-bs-target="#deleteSprintModal">
                            <i data-lucide="trash-2" class="w-4 h-4 inline me-1"></i> Eliminar Sprint
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <div class="d-flex justify-content-between align-items-end mb-2">
                    <span class="fw-bold small text-dark">Sprint Progress</span>
                    <span class="fw-bold small" 
                          th:classappend="${sprint.status.name() == 'CONCLUIDO' ? 'text-success' : 'text-primary'}"
                          th:text="${sprintProgress} + '%'">38%</span>
                </div>
                <div class="progress" style="height: 10px; border-radius: 99px; background-color: #e9ecef;">
                    <div class="progress-bar rounded-pill" 
                         th:classappend="${sprint.status.name() == 'CONCLUIDO' ? 'bg-success' : 'bg-primary'}"
                         role="progressbar" 
                         th:style="'width: ' + ${sprintProgress} + '%'"></div>
                </div>
                <div class="mt-2 d-flex justify-content-between align-items-center">
                    <span class="text-muted small" th:text="${doneCount} + ' de ' + ${totalStories} + ' user stories concluídas'">5/13 user stories</span>
                </div>
            </div>
        </div>

        <div class="kanban-board">
            
            <div class="kanban-column col-todo" th:attrappend="ondragover=${sprint.status.name() != 'CONCLUIDO' ? 'allowDrop(event)' : ''}, ondrop=${sprint.status.name() != 'CONCLUIDO' ? 'drop(event, &quot;TODO&quot;)' : ''}, ondragenter=${sprint.status.name() != 'CONCLUIDO' ? 'dragEnter(event)' : ''}, ondragleave=${sprint.status.name() != 'CONCLUIDO' ? 'dragLeave(event)' : ''}">
                <div class="column-header">
                    <div class="d-flex align-items-center gap-2">
                        <i data-lucide="list" class="w-4 h-4 text-muted"></i>
                        <span class="col-title">To Do</span>
                    </div>
                    <span class="col-count" th:text="${todoCount}">0</span>
                </div>
                
                <div th:each="story : ${sprint.userStories}" th:if="${story.status.name() == 'TODO'}" 
                     class="story-card" 
                     th:attr="draggable=${sprint.status.name() != 'CONCLUIDO' ? 'true' : 'false'}"
                     th:attrappend="ondragstart=${sprint.status.name() != 'CONCLUIDO' ? 'drag(event)' : ''}, ondblclick=${sprint.status.name() != 'CONCLUIDO' ? 'editStory(this)' : ''}"
                     th:id="'story-' + ${story.id}" th:data-id="${story.id}" 
                     th:data-name="${story.name}" th:data-description="${story.description}"
                     th:data-priority="${story.priority}" th:data-points="${story.storyPoints}"
                     th:data-assignee="${story.assignee != null ? story.assignee.id : ''}">
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted small fw-bold" th:text="'US-' + ${story.id}">#5</span>
                        <span class="priority-badge" th:classappend="'prio-' + ${story.priority}" th:text="${story.priority}">HIGH</span>
                    </div>
                    <h6 class="fw-bold text-dark mb-2" style="font-size: 0.95rem;" th:text="${story.name}">Database Schema</h6>
                    <p class="text-muted small mb-2" style="font-size: 0.85rem;" th:text="${story.description}">Descrição</p>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3 border-top pt-2">
                        <div class="d-flex align-items-center gap-2">
                            <div>
                                <img th:if="${story.assignee != null and userProfileImageMap[story.assignee.id] != null}"
                                     th:src="@{'/uploads/profile-images/' + ${userProfileImageMap[story.assignee.id]}}"
                                     th:alt="${story.assignee.name}"
                                     class="rounded-circle"
                                     style="width:28px; height:28px; object-fit:cover;" />
                                <div th:unless="${story.assignee != null and userProfileImageMap[story.assignee.id] != null}" class="assignee-avatar" th:text="${story.assignee != null ? #strings.substring(story.assignee.name,0,1) : '?'}">?</div>
                            </div>
                            <span class="small text-muted" th:text="${story.assignee != null ? story.assignee.name : 'Unassigned'}">Unassigned</span>
                        </div>
                        <span class="badge bg-info text-white rounded-pill" th:text="${story.storyPoints != null ? story.storyPoints + ' pts' : '0 pts'}">3 pts</span>
                    </div>
                </div>
            </div>

            <div class="kanban-column col-progress" th:attrappend="ondragover=${sprint.status.name() != 'CONCLUIDO' ? 'allowDrop(event)' : ''}, ondrop=${sprint.status.name() != 'CONCLUIDO' ? 'drop(event, &quot;IN_PROGRESS&quot;)' : ''}, ondragenter=${sprint.status.name() != 'CONCLUIDO' ? 'dragEnter(event)' : ''}, ondragleave=${sprint.status.name() != 'CONCLUIDO' ? 'dragLeave(event)' : ''}">
                <div class="column-header">
                    <div class="d-flex align-items-center gap-2">
                        <i data-lucide="loader-2" class="w-4 h-4 text-warning"></i>
                        <span class="col-title">In Progress</span>
                    </div>
                    <span class="col-count" th:text="${progressCount}">0</span>
                </div>
                 <div th:each="story : ${sprint.userStories}" th:if="${story.status.name() == 'IN_PROGRESS'}" 
                     class="story-card" 
                     th:attr="draggable=${sprint.status.name() != 'CONCLUIDO' ? 'true' : 'false'}"
                     th:attrappend="ondragstart=${sprint.status.name() != 'CONCLUIDO' ? 'drag(event)' : ''}, ondblclick=${sprint.status.name() != 'CONCLUIDO' ? 'editStory(this)' : ''}"
                     th:id="'story-' + ${story.id}" th:data-id="${story.id}"
                     th:data-name="${story.name}" th:data-description="${story.description}"
                     th:data-priority="${story.priority}" th:data-points="${story.storyPoints}"
                     th:data-assignee="${story.assignee != null ? story.assignee.id : ''}">
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted small fw-bold" th:text="'US-' + ${story.id}">#</span>
                        <span class="priority-badge" th:classappend="'prio-' + ${story.priority}" th:text="${story.priority}">MEDIUM</span>
                    </div>
                    <h6 class="fw-bold text-dark mb-2" th:text="${story.name}">Task Name</h6>
                    <p class="text-muted small mb-2" style="font-size: 0.85rem;" th:text="${story.description}">Descrição</p>
                    <div class="d-flex justify-content-between align-items-center mt-3 border-top pt-2">
                         <div class="d-flex align-items-center gap-2">
                            <div>
                                <img th:if="${story.assignee != null and userProfileImageMap[story.assignee.id] != null}"
                                     th:src="@{'/uploads/profile-images/' + ${userProfileImageMap[story.assignee.id]}}"
                                     th:alt="${story.assignee.name}"
                                     class="rounded-circle"
                                     style="width:28px; height:28px; object-fit:cover;" />
                                <div th:unless="${story.assignee != null and userProfileImageMap[story.assignee.id] != null}" class="assignee-avatar" th:text="${story.assignee != null ? #strings.substring(story.assignee.name,0,1) : '?'}">?</div>
                            </div>
                            <span class="small text-muted" th:text="${story.assignee != null ? story.assignee.name : 'Unassigned'}">Unassigned</span>
                        </div>
                        <span class="badge bg-info text-white rounded-pill" th:text="${story.storyPoints != null ? story.storyPoints + ' pts' : '0 pts'}">3 pts</span>
                    </div>
                </div>
            </div>

            <div class="kanban-column col-testing" th:attrappend="ondragover=${sprint.status.name() != 'CONCLUIDO' ? 'allowDrop(event)' : ''}, ondrop=${sprint.status.name() != 'CONCLUIDO' ? 'drop(event, &quot;TESTING&quot;)' : ''}, ondragenter=${sprint.status.name() != 'CONCLUIDO' ? 'dragEnter(event)' : ''}, ondragleave=${sprint.status.name() != 'CONCLUIDO' ? 'dragLeave(event)' : ''}">
                <div class="column-header">
                    <div class="d-flex align-items-center gap-2">
                        <i data-lucide="flask-conical" class="w-4 h-4 text-primary"></i> <span class="col-title">Testing</span>
                    </div>
                    <span class="col-count" th:text="${testingCount}">0</span>
                </div>
                <div th:each="story : ${sprint.userStories}" th:if="${story.status.name() == 'TESTING'}" 
                     class="story-card" 
                     th:attr="draggable=${sprint.status.name() != 'CONCLUIDO' ? 'true' : 'false'}"
                     th:attrappend="ondragstart=${sprint.status.name() != 'CONCLUIDO' ? 'drag(event)' : ''}, ondblclick=${sprint.status.name() != 'CONCLUIDO' ? 'editStory(this)' : ''}"
                     th:id="'story-' + ${story.id}" th:data-id="${story.id}"
                     th:data-name="${story.name}" th:data-description="${story.description}"
                     th:data-priority="${story.priority}" th:data-points="${story.storyPoints}"
                     th:data-assignee="${story.assignee != null ? story.assignee.id : ''}">
                     <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted small fw-bold" th:text="'US-' + ${story.id}">#</span>
                        <span class="priority-badge" th:classappend="'prio-' + ${story.priority}" th:text="${story.priority}">LOW</span>
                    </div>
                    <h6 class="fw-bold text-dark mb-2" th:text="${story.name}">Task Name</h6>
                    <p class="text-muted small mb-2" style="font-size: 0.85rem;" th:text="${story.description}">Descrição</p>
                     <div class="d-flex justify-content-between align-items-center mt-3 border-top pt-2">
                         <div class="d-flex align-items-center gap-2">
                            <div>
                                <img th:if="${story.assignee != null and userProfileImageMap[story.assignee.id] != null}"
                                     th:src="@{'/uploads/profile-images/' + ${userProfileImageMap[story.assignee.id]}}"
                                     th:alt="${story.assignee.name}"
                                     class="rounded-circle"
                                     style="width:28px; height:28px; object-fit:cover;" />
                                <div th:unless="${story.assignee != null and userProfileImageMap[story.assignee.id] != null}" class="assignee-avatar" th:text="${story.assignee != null ? #strings.substring(story.assignee.name,0,1) : '?'}">?</div>
                            </div>
                            <span class="small text-muted" th:text="${story.assignee != null ? story.assignee.name : 'Unassigned'}">Unassigned</span>
                        </div>
                        <span class="badge bg-info text-white rounded-pill" th:text="${story.storyPoints != null ? story.storyPoints + ' pts' : '0 pts'}">3 pts</span>
                    </div>
                </div>
            </div>

            <div class="kanban-column col-done" th:attrappend="ondragover=${sprint.status.name() != 'CONCLUIDO' ? 'allowDrop(event)' : ''}, ondrop=${sprint.status.name() != 'CONCLUIDO' ? 'drop(event, &quot;DONE&quot;)' : ''}, ondragenter=${sprint.status.name() != 'CONCLUIDO' ? 'dragEnter(event)' : ''}, ondragleave=${sprint.status.name() != 'CONCLUIDO' ? 'dragLeave(event)' : ''}">
                <div class="column-header">
                    <div class="d-flex align-items-center gap-2">
                        <i data-lucide="check-circle-2" class="w-4 h-4 text-success"></i>
                        <span class="col-title">Done</span>
                    </div>
                    <span class="col-count" th:text="${doneCount}">0</span>
                </div>
                 <div th:each="story : ${sprint.userStories}" th:if="${story.status.name() == 'DONE'}" 
                     class="story-card" 
                     th:attr="draggable=${sprint.status.name() != 'CONCLUIDO' ? 'true' : 'false'}"
                     th:attrappend="ondragstart=${sprint.status.name() != 'CONCLUIDO' ? 'drag(event)' : ''}, ondblclick=${sprint.status.name() != 'CONCLUIDO' ? 'editStory(this)' : ''}"
                     th:id="'story-' + ${story.id}" th:data-id="${story.id}"
                     th:data-name="${story.name}" th:data-description="${story.description}"
                     th:data-priority="${story.priority}" th:data-points="${story.storyPoints}"
                     th:data-assignee="${story.assignee != null ? story.assignee.id : ''}">
                     <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted small fw-bold" th:text="'US-' + ${story.id}">#</span>
                        <span class="priority-badge" th:classappend="'prio-' + ${story.priority}" th:text="${story.priority}">HIGH</span>
                    </div>
                    <h6 class="fw-bold text-dark mb-2" style="text-decoration: line-through; opacity: 0.7;" th:text="${story.name}">Task Name</h6>
                    <p class="text-muted small mb-2" style="font-size: 0.85rem; text-decoration: line-through; opacity: 0.7;" th:text="${story.description}">Descrição</p>
                     <div class="d-flex justify-content-between align-items-center mt-3 border-top pt-2">
                         <div class="d-flex align-items-center gap-2">
                            <div>
                                <img th:if="${story.assignee != null and userProfileImageMap[story.assignee.id] != null}"
                                     th:src="@{'/uploads/profile-images/' + ${userProfileImageMap[story.assignee.id]}}"
                                     th:alt="${story.assignee.name}"
                                     class="rounded-circle"
                                     style="width:28px; height:28px; object-fit:cover;" />
                                <div th:unless="${story.assignee != null and userProfileImageMap[story.assignee.id] != null}" class="assignee-avatar" th:text="${story.assignee != null ? #strings.substring(story.assignee.name,0,1) : '?'}">?</div>
                            </div>
                            <span class="small text-muted" th:text="${story.assignee != null ? story.assignee.name : 'Unassigned'}">Unassigned</span>
                        </div>
                        <span class="badge bg-success text-white rounded-pill" th:text="${story.storyPoints != null ? story.storyPoints + ' pts' : '0 pts'}">3 pts</span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal para Confirmar Eliminar User Story -->
    <div class="modal fade" id="deleteUserStoryConfirmationModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold text-danger">Eliminar User Story</h4>
                        <p class="text-muted small mb-0">Esta ação é irreversível.</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0 text-dark">Tem a certeza que deseja eliminar esta User Story?</p>
                </div>
                <div class="modal-footer border-0 pt-2 px-0 pb-0">
                    <div class="w-100 d-flex gap-2">
                        <button type="button" class="btn btn-light rounded-pill flex-fill fw-bold" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger rounded-pill flex-fill fw-bold" onclick="executeDeleteStory()">Sim, Eliminar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Concluir Sprint -->
    <div class="modal fade" id="completeSprintModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold text-primary">Concluir Sprint</h4>
                        <p class="text-muted small mb-0">Tem certeza que deseja marcar esta sprint como concluída?</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Todas as User Stories devem estar em DONE para completar a sprint.</p>
                </div>
                <div class="modal-footer border-0 pt-2 px-0 pb-0">
                    <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4 fw-bold" onclick="confirmCompleteSprint()" data-bs-dismiss="modal">
                        <i data-lucide="check-circle" class="w-4 h-4 inline me-1"></i> Concluir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Reabrir Sprint -->
    <div class="modal fade" id="reopenSprintModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold text-warning">Reabrir Sprint</h4>
                        <p class="text-muted small mb-0">Tem certeza que deseja reabrir esta sprint?</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">A sprint voltará ao estado EM_CURSO.</p>
                </div>
                <div class="modal-footer border-0 pt-2 px-0 pb-0">
                    <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning rounded-pill px-4 fw-bold" onclick="confirmReopenSprint()" data-bs-dismiss="modal">
                        <i data-lucide="rotate-ccw" class="w-4 h-4 inline me-1"></i> Reabrir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Eliminar Sprint -->
    <div class="modal fade" id="deleteSprintModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold text-danger">Eliminar Sprint</h4>
                        <p class="text-muted small mb-0">Tem certeza que deseja eliminar esta sprint?</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0 text-danger fw-bold">Esta ação não pode ser desfeita. Todas as User Stories desta sprint serão perdidas.</p>
                </div>
                <div class="modal-footer border-0 pt-2 px-0 pb-0">
                    <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger rounded-pill px-4 fw-bold" onclick="confirmDeleteSprint()" data-bs-dismiss="modal">
                        <i data-lucide="trash-2" class="w-4 h-4 inline me-1"></i> Sim, Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para criar User Story -->
    <div class="modal fade" id="newUserStoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold">Nova User Story</h4>
                        <p class="text-muted small mb-0">Adicionar nova tarefa à sprint</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newUserStoryForm">
                        <input type="hidden" name="sprintId" th:value="${sprint.id}">

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Nome da User Story</label>
                            <input type="text" id="storyName" class="form-control bg-light border-0 py-2" placeholder="ex: Implementar sistema de login" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Descrição</label>
                            <textarea id="storyDescription" class="form-control bg-light border-0" rows="3" placeholder="Descreve o que precisa ser feito..."></textarea>
                        </div>

                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label fw-bold small">Prioridade</label>
                                <select id="storyPriority" class="form-select bg-light border-0 py-2" required>
                                    <option value="LOW">Baixa</option>
                                    <option value="MEDIUM" selected>Média</option>
                                    <option value="HIGH">Alta</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold small">Story Points</label>
                                <input type="number" id="storyPoints" class="form-control bg-light border-0 py-2" min="1" max="21" value="3" required>
                            </div>
                        </div>

                        <div class="mb-3 mt-3">
                            <label class="form-label fw-bold small">Atribuir a</label>
                            <select id="storyAssignee" class="form-select bg-light border-0 py-2">
                                <option value="">Não atribuído</option>
                                <option th:each="member : ${teamMembers}" th:value="${member.id}" th:text="${member.name}"
                                        th:disabled="${productOwnerId != null && member.id == productOwnerId}">Membro</option>
                            </select>
                        </div>

                        <div class="modal-footer border-0 pt-4 px-0 pb-0">
                            <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success rounded-pill px-4 fw-bold">Criar User Story</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar User Story -->
    <div class="modal fade" id="editUserStoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold">Editar User Story</h4>
                        <p class="text-muted small mb-0">Atualizar informações da tarefa</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserStoryForm">
                        <input type="hidden" id="editStoryId">

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Nome da User Story</label>
                            <input type="text" id="editStoryName" class="form-control bg-light border-0 py-2" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Descrição</label>
                            <textarea id="editStoryDescription" class="form-control bg-light border-0" rows="3"></textarea>
                        </div>

                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label fw-bold small">Prioridade</label>
                                <select id="editStoryPriority" class="form-select bg-light border-0 py-2" required>
                                    <option value="LOW">Baixa</option>
                                    <option value="MEDIUM">Média</option>
                                    <option value="HIGH">Alta</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold small">Story Points</label>
                                <input type="number" id="editStoryPoints" class="form-control bg-light border-0 py-2" min="1" max="21" required>
                            </div>
                        </div>

                        <div class="mb-3 mt-3">
                            <label class="form-label fw-bold small">Atribuir a</label>
                            <select id="editStoryAssignee" class="form-select bg-light border-0 py-2">
                                <option value="">Não atribuído</option>
                                <option th:each="member : ${teamMembers}" th:value="${member.id}" th:text="${member.name}"
                                        th:disabled="${productOwnerId != null && member.id == productOwnerId}">Membro</option>
                            </select>
                        </div>

                        <div class="modal-footer border-0 pt-4 px-0 pb-0">
                            <button type="button" class="btn btn-danger rounded-pill px-4 fw-bold" onclick="deleteStory()">Eliminar</button>
                            <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success rounded-pill px-4 fw-bold">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/webjars/bootstrap/5.3.0/js/bootstrap.bundle.min.js}"></script>
    <script th:inline="javascript">
        const sprintId = /*[[${sprint.id}]]*/ 0;
        const projectId = /*[[${projectId}]]*/ 0;
        const userId = /*[[${teacher != null ? teacher.id : student.id}]]*/ 0;
        const isTeacher = /*[[${teacher != null}]]*/ false;
    </script>
    <script>
        lucide.createIcons();

        // Load notifications on page load
        document.addEventListener('DOMContentLoaded', function() {
            fetchNotifications();
        });

        // DRAG AND DROP LOGIC
        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
            ev.dataTransfer.setData("storyId", ev.target.getAttribute("data-id"));
            ev.target.classList.add('dragging');
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function dragEnter(ev) {
            if (ev.target.classList.contains('kanban-column')) {
                ev.target.classList.add('drag-over');
            }
        }

        function dragLeave(ev) {
            if (ev.target.classList.contains('kanban-column')) {
                ev.target.classList.remove('drag-over');
            }
        }

        function drop(ev, newStatus) {
            ev.preventDefault();
            var data = ev.dataTransfer.getData("text");
            var storyId = ev.dataTransfer.getData("storyId");
            var draggedElement = document.getElementById(data);
            
            // Encontrar a coluna alvo (pode ser o target direto ou um pai)
            let column = ev.target;
            while(column && !column.classList.contains('kanban-column')) {
                column = column.parentElement;
            }

            if (column) {
                column.classList.remove('drag-over');
                column.appendChild(draggedElement);
                draggedElement.classList.remove('dragging');

                // CHAMADA API PARA ATUALIZAR STATUS
                fetch(`/api/stories/${storyId}/move?status=${newStatus}`, {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        console.log("Status updated to " + newStatus);
                        // Recarregar para atualizar contadores e progresso
                        location.reload(); 
                    } else {
                        alert("Erro ao mover tarefa.");
                        location.reload();
                    }
                }).catch(error => {
                    console.error("Error:", error);
                    alert("Erro ao mover tarefa.");
                    location.reload();
                });
            }
        }

        // Criar User Story
        document.getElementById('newUserStoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const assigneeId = document.getElementById('storyAssignee').value;
            
            const userStory = {
                name: document.getElementById('storyName').value,
                description: document.getElementById('storyDescription').value,
                priority: document.getElementById('storyPriority').value,
                storyPoints: parseInt(document.getElementById('storyPoints').value),
                sprint: { id: sprintId },
                assignee: assigneeId ? { id: parseInt(assigneeId) } : null,
                status: 'TODO'
            };

            fetch('/api/stories', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userStory)
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Erro ao criar User Story');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao criar User Story');
            });
        });

        // Editar User Story (duplo clique)
        function editStory(element) {
            const storyId = element.getAttribute('data-id');
            const storyName = element.getAttribute('data-name');
            const storyDescription = element.getAttribute('data-description');
            const storyPriority = element.getAttribute('data-priority');
            const storyPoints = element.getAttribute('data-points');
            const storyAssignee = element.getAttribute('data-assignee');

            // Preencher o modal
            document.getElementById('editStoryId').value = storyId;
            document.getElementById('editStoryName').value = storyName;
            document.getElementById('editStoryDescription').value = storyDescription || '';
            document.getElementById('editStoryPriority').value = storyPriority;
            document.getElementById('editStoryPoints').value = storyPoints;
            document.getElementById('editStoryAssignee').value = storyAssignee || '';

            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('editUserStoryModal'));
            modal.show();
        }

        // Guardar alterações da User Story
        document.getElementById('editUserStoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const storyId = document.getElementById('editStoryId').value;
            const assigneeId = document.getElementById('editStoryAssignee').value;
            
            const userStory = {
                name: document.getElementById('editStoryName').value,
                description: document.getElementById('editStoryDescription').value,
                priority: document.getElementById('editStoryPriority').value,
                storyPoints: parseInt(document.getElementById('editStoryPoints').value),
                assignee: assigneeId ? { id: parseInt(assigneeId) } : null
            };

            fetch(`/api/stories/${storyId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userStory)
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Erro ao atualizar User Story');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao atualizar User Story');
            });
        });

        // Eliminar User Story
        function deleteStory() {
            const editModalEl = document.getElementById('editUserStoryModal');
            const editModal = bootstrap.Modal.getInstance(editModalEl);
            if (editModal) {
                editModal.hide();
            }

            const confirmModalEl = document.getElementById('deleteUserStoryConfirmationModal');
            const confirmModal = new bootstrap.Modal(confirmModalEl);

            confirmModalEl.addEventListener('hidden.bs.modal', function onHidden() {
                if (editModal) {
                    editModal.show();
                }
            }, { once: true });

            confirmModal.show();
        }

        function executeDeleteStory() {
            const storyId = document.getElementById('editStoryId').value;

            fetch(`/api/stories/${storyId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Erro ao eliminar User Story');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao eliminar User Story');
            });
        }

        // Completar Sprint
        function confirmCompleteSprint() {
            fetch(`/sprints/${sprintId}/complete`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    return response.json().then(data => {
                        console.error(data.message || 'Não é possível completar a sprint.');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function confirmReopenSprint() {
            fetch(`/sprints/${sprintId}/reopen`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    console.error('Erro ao reabrir sprint.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function confirmDeleteSprint() {
            fetch(`/sprints/${sprintId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    // Redirecionar para a home correta
                    if (isTeacher) {
                        window.location.href = `/view/teacher/home/${userId}`;
                    } else {
                        window.location.href = `/view/student/home/${userId}?tab=projects`;
                    }
                } else {
                    console.error('Erro ao eliminar sprint.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // Ativar Dark Mode se estiver salvo
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-theme');
        }

        // Toggle notification sidebar
        function toggleNotificationSidebar() {
            const sidebar = document.getElementById('notificationSidebar');
            sidebar.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                fetchNotifications();
            }
        }

        async function fetchNotifications() {
            const notificationsContainer = document.getElementById('notificationsContainer');
            const notificationCountBadge = document.getElementById('notificationCount');
            const notificationBellIcon = document.getElementById('notificationBellIcon');
            const noNotificationsMessage = document.getElementById('noNotifications');

            notificationsContainer.innerHTML = '<div class="text-center text-muted mt-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">A carregar notificações...</p></div>';
            notificationCountBadge.style.display = 'none';
            notificationBellIcon.classList.remove('text-danger');
            notificationBellIcon.classList.add('text-secondary');

            let notifications = [];
            try {
                const userType = /*[[${teacher != null ? 'teacher' : 'student'}]]*/ 'student';
                const response = await fetch('/api/notifications/' + userType);
                if (response.ok) {
                    notifications = await response.json();
                } else {
                    console.log('API returned ' + response.status + ', using empty list');
                }
            } catch (apiError) {
                console.log('API error:', apiError, '- using empty list');
            }

            notificationsContainer.innerHTML = '';

            if (notifications.length === 0) {
                noNotificationsMessage.style.display = 'block';
                notificationsContainer.appendChild(noNotificationsMessage);
            } else {
                noNotificationsMessage.style.display = 'none';
                notifications.forEach(notification => {
                    const notificationElement = createNotificationElement(notification);
                    notificationsContainer.appendChild(notificationElement);
                });
            }

            const unreadCount = notifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                notificationCountBadge.textContent = unreadCount;
                notificationCountBadge.style.display = 'block';
                notificationBellIcon.classList.remove('text-secondary');
                notificationBellIcon.classList.add('text-danger');
            } else {
                notificationCountBadge.style.display = 'none';
                notificationBellIcon.classList.remove('text-danger');
                notificationBellIcon.classList.add('text-secondary');
            }

            lucide.createIcons();
        }

        function createNotificationElement(notification) {
            const item = document.createElement('div');
            item.classList.add('notification-item');
            if (!notification.read) {
                item.classList.add('unread');
            }

            let iconHtml = '';
            let iconBgClass = 'bg-primary';
            switch (notification.type) {
                case 'AWARD':
                    iconHtml = '<i data-lucide="award" class="w-5 h-5"></i>';
                    iconBgClass = 'bg-primary';
                    break;
                case 'TEAM_CREATED':
                    iconHtml = '<i data-lucide="users" class="w-5 h-5"></i>';
                    iconBgClass = 'bg-warning';
                    break;
                case 'PROJECT_COMPLETED':
                    iconHtml = '<i data-lucide="check-circle" class="w-5 h-5"></i>';
                    iconBgClass = 'bg-success';
                    break;
                case 'REMINDER':
                    iconHtml = '<i data-lucide="info" class="w-5 h-5"></i>';
                    iconBgClass = 'bg-info';
                    break;
                default:
                    iconHtml = '<i data-lucide="bell" class="w-5 h-5"></i>';
                    iconBgClass = 'bg-secondary';
            }

            item.innerHTML = `
                <div class="notification-icon ${iconBgClass}">${iconHtml}</div>
                <div class="notification-content">
                    <h6>${notification.title}</h6>
                    <p>${notification.message}</p>
                    <div class="notification-actions">
                        ${notification.link ? `<button class="btn btn-sm btn-outline-primary" onclick="window.location.href='${notification.link}'">Ver Detalhes</button>` : ''}
                        ${!notification.read ? `<button class="btn btn-sm btn-outline-secondary" onclick="markNotificationAsRead('${notification.id}')">Marcar como lida</button>` : ''}
                    </div>
                </div>
                <span class="notification-time">${timeAgo(notification.timestamp)}</span>
            `;
            return item;
        }

        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    fetchNotifications();
                }
            } catch (error) {
                console.error('Erro ao marcar notificação como lida:', error);
            }
        }

        function timeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const seconds = Math.floor((now - date) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " anos atrás";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " meses atrás";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " dias atrás";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " horas atrás";
            return Math.floor(seconds / 60) + " minutos atrás";
        }
    </script>
    <script th:src="@{/js/app.js}"></script>
</body>
</html>