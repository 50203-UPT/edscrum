<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>EduScrum - Área do Estudante</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/images/favicon.svg}">
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.0/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/estilo.css}">
    <link rel="stylesheet" th:href="@{/css/dark-theme.css}">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
    /* Cartões de Resumo (Topo) */
    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        border: 1px solid #f0f0f0;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .stat-icon-wrapper {
        width: 40px; 
        height: 40px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        border-radius: 50%;
    }

    /* Tabela de Comparação (Esquerda) */
    .comparison-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        border-radius: 12px;
        margin-bottom: 12px;
        font-weight: 500;
    }
    .comp-user { background-color: #e3f2fd; color: #0d47a1; }
    .comp-avg { background-color: #f8f9fa; color: #495057; }
    .comp-diff { background-color: #e8f5e9; color: #1b5e20; }

    /* Top 5 Estudantes (Direita) */
    .ranking-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 8px;
        font-weight: 500;
    }
    .rank-gold { background-color: #fff9c4; color: #fbc02d; }
    .rank-silver { background-color: #f5f5f5; color: #616161; }
    .rank-bronze { background-color: #fff3e0; color: #ef6c00; }
    .rank-normal { background-color: transparent; color: #495057; }
    
    /* CORES DOS ROLES: PO (azul), SM (roxo), Dev (verde) */
    .badge-role { font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; font-weight: 600; }
    .role-po { background-color: #cce5ff; color: #004085; } /* Azul */
    .role-sm { background-color: #e2d9f3; color: #6f42c1; } /* Roxo */
    .role-dev { background-color: #d1e7dd; color: #0f5132; } /* Verde */
    
    .rank-me {
        border: 2px solid #90caf9;
        background-color: #e3f2fd;
    }

    .rank-badge {
        width: 28px; 
        height: 28px; 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        font-size: 0.8rem;
        margin-right: 12px;
        background: white;
        font-weight: bold;
    }

    /* Estilos para a foto de perfil */
    #removeImageBtn:hover,
    label[for="imageUploadStudent"]:hover {
        transform: scale(1.1);
    }

    #removeImageBtn {
        transition: all 0.3s ease;
    }

    label[for="imageUploadStudent"] {
        transition: all 0.3s ease;
    }

    #profileImagePreview,
    #profileImagePlaceholder {
        transition: all 0.3s ease;
    }

    /* Notification Sidebar Styles */
    .notification-sidebar {
        position: fixed;
        top: 0;
        right: -400px; /* Hidden by default */
        width: 400px;
        height: 100%;
        background-color: #f8f9fa; /* Matching the body background */
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 1050;
        transition: right 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
        border-left: 1px solid #e9ecef;
    }

    .notification-sidebar.open {
        right: 0; /* Visible */
    }

    .notification-sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #ffffff; /* White header for better contrast */
    }

    .notification-sidebar-header h5 {
        color: var(--bs-body-color);
        cursor: pointer;
    }

    .notification-sidebar-body {
        flex-grow: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background-color: #f8f9fa;
    }

    .notification-item {
        background-color: transparent;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        transition: all 0.2s ease;
        color: #212529;
    }

    .notification-item:hover {
        background-color: rgba(0, 0, 0, 0.05);
        border-color: rgba(0, 0, 0, 0.2);
    }

    .notification-item.unread {
        background-color: rgba(13, 110, 253, 0.1);
        border-color: rgba(13, 110, 253, 0.2);
    }

    .notification-item.unread:hover {
        background-color: rgba(13, 110, 253, 0.15);
        border-color: rgba(13, 110, 253, 0.3);
    }

    .notification-content h6 {
        color: inherit;
        margin: 0 0 4px 0;
        font-weight: 600;
    }

    .notification-content p {
        color: inherit;
        opacity: 0.9;
        margin: 0 0 8px 0;
    }

    .notification-time {
        font-size: 0.8rem;
        opacity: 0.8;
        color: inherit;
    }

    .notification-icon {
        flex-shrink: 0;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .notification-content {
        flex-grow: 1;
    }

    .notification-content h6 {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--bs-body-color);
    }

    .notification-content p {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .notification-time {
        font-size: 0.75rem;
        color: #adb5bd;
        text-align: right;
        flex-shrink: 0;
    }

    .notification-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .notification-actions .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    .cursor-pointer {
        cursor: pointer;
    }
    
    .hover-shadow:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        transform: translateY(-2px);
    }
    
    .transition {
        transition: all 0.3s ease;
    }
    </style>
</head>
<body class="student-bg">

    <script th:inline="javascript">
        window.currentStudentId = /*[[${student.id}]]*/ null;
    </script>

    <script>
        let currentStudentCourseId = null;

        function setupCourseDetailsModal(button) {
            const courseId = button.getAttribute('data-course-id');
            const courseName = button.getAttribute('data-course-name');
            currentStudentCourseId = courseId;
            
            console.log('setupCourseDetailsModal called:', { currentStudentId: window.currentStudentId, courseId, courseName });
            
            document.getElementById('courseDetailsTitle').textContent = courseName;
            
            // Fetch student's team status for this course
            fetch('/api/teams/student-team/' + window.currentStudentId + '/course/' + courseId)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error('HTTP error, status = ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Team data received:', data);
                    if (data.teamId) {
                        // Student is in a team - show team details
                        showTeamDetails(data);
                    } else {
                        // Student is not in a team - show create/join options
                        showNoTeamOptions();
                    }
                })
                .catch(error => {
                    console.error('Error loading team info:', error);
                    showNoTeamOptions();
                });
        }

        function showTeamDetails(teamData) {
            console.log('showTeamDetails called with:', teamData);
            const detailsSection = document.getElementById('studentTeamDetailsSection');
            const noTeamSection = document.getElementById('studentNoTeamSection');
            const teamCard = document.getElementById('teamDetailsCard');
            
            if (!detailsSection || !teamCard) {
                console.error('Missing DOM elements for team details');
                return;
            }
            
            detailsSection.style.display = 'block';
            if (noTeamSection) noTeamSection.style.display = 'none';
            
            let membersHtml = '';
            
            if (teamData.productOwner) {
                membersHtml += `<div class="d-flex justify-content-between align-items-center py-2">
                    <div class="d-flex align-items-center gap-2">
                        <div class="text-white rounded-circle d-flex justify-content-center align-items-center" style="width:24px; height:24px; background-color:#0d6efd;">
                            ${teamData.productOwner.name.charAt(0).toUpperCase()}
                        </div>
                        <span class="small fw-bold">${teamData.productOwner.name}</span>
                    </div>
                    <span class="badge-role role-po">Product Owner</span>
                </div>`;
            }
            
            if (teamData.scrumMaster) {
                membersHtml += `<div class="d-flex justify-content-between align-items-center py-2">
                    <div class="d-flex align-items-center gap-2">
                        <div class="text-white rounded-circle d-flex justify-content-center align-items-center" style="width:24px; height:24px; background-color:#6f42c1;">
                            ${teamData.scrumMaster.name.charAt(0).toUpperCase()}
                        </div>
                        <span class="small fw-bold">${teamData.scrumMaster.name}</span>
                    </div>
                    <span class="badge-role role-sm">Scrum Master</span>
                </div>`;
            }
            
            if (teamData.developers && teamData.developers.length > 0) {
                teamData.developers.forEach(dev => {
                    membersHtml += `<div class="d-flex justify-content-between align-items-center py-2">
                        <div class="d-flex align-items-center gap-2">
                            <div class="bg-success text-white rounded-circle d-flex justify-content-center align-items-center" style="width:24px; height:24px;">
                                ${dev.name.charAt(0).toUpperCase()}
                            </div>
                            <span class="small fw-bold">${dev.name}</span>
                        </div>
                        <span class="badge-role role-dev">Developer</span>
                    </div>`;
                });
            }
            
            teamCard.innerHTML = `
                <h6 class="fw-bold text-dark mb-3">${teamData.name}</h6>
                <p class="text-muted small mb-3">${teamData.currentMemberCount}/${teamData.maxMembers} membros</p>
                ${membersHtml}
            `;
            console.log('Team details displayed successfully');
        }

        function showNoTeamOptions() {
            console.log('showNoTeamOptions called');
            const detailsSection = document.getElementById('studentTeamDetailsSection');
            const noTeamSection = document.getElementById('studentNoTeamSection');
            
            if (!noTeamSection) {
                console.error('Missing DOM element: studentNoTeamSection');
                return;
            }
            
            if (detailsSection) detailsSection.style.display = 'none';
            noTeamSection.style.display = 'block';
            console.log('No team options displayed successfully');
        }

        function setupCreateTeamModal() {
            document.getElementById('studentTeamCourseId').value = currentStudentCourseId;
            
            // Load coursemates for this course
            loadCoursematesForTeamCreation(currentStudentCourseId);
        }

        function setupJoinTeamModal() {
            loadAvailableTeams();
        }

        function loadAvailableTeams() {
            fetch('/api/teams/available-teams/' + currentStudentCourseId)
                .then(response => response.json())
                .then(teams => {
                    const container = document.getElementById('availableTeamsContainer');
                    const noTeamsMsg = document.getElementById('noTeamsMessage');
                    
                    if (!teams || teams.length === 0) {
                        container.innerHTML = '';
                        noTeamsMsg.style.display = 'block';
                        return;
                    }
                    
                    noTeamsMsg.style.display = 'none';
                    container.innerHTML = teams.map(team => {
                        // Build available roles
                        let rolesHtml = '<div class="d-flex gap-2 mt-2">';
                        
                        if (!team.hasProductOwner) {
                            rolesHtml += `<button class="btn btn-sm btn-outline-primary rounded-pill px-2" 
                                    onclick="joinTeamWithRole(${team.id}, 'PRODUCT_OWNER')"
                                    data-bs-dismiss="modal">
                                <i data-lucide="user-check" style="width:12px;height:12px;"></i> PO
                            </button>`;
                        }
                        
                        if (!team.hasScrumMaster) {
                            rolesHtml += `<button class="btn btn-sm btn-outline-purple rounded-pill px-2" 
                                    onclick="joinTeamWithRole(${team.id}, 'SCRUM_MASTER')"
                                    data-bs-dismiss="modal"
                                    style="border-color: #6f42c1; color: #6f42c1;">
                                <i data-lucide="shield" style="width:12px;height:12px;"></i> SM
                            </button>`;
                        }
                        
                        rolesHtml += `<button class="btn btn-sm btn-outline-success rounded-pill px-2" 
                                onclick="joinTeamWithRole(${team.id}, 'DEVELOPER')"
                                data-bs-dismiss="modal">
                            <i data-lucide="code" style="width:12px;height:12px;"></i> Dev
                        </button>`;
                        
                        rolesHtml += '</div>';
                        
                        // Show current roles
                        let statusHtml = '<div class="d-flex gap-1 flex-wrap">';
                        if (team.hasProductOwner) {
                            statusHtml += '<span class="badge badge-role role-po" style="font-size:0.65rem;">PO ✓</span>';
                        }
                        if (team.hasScrumMaster) {
                            statusHtml += '<span class="badge badge-role role-sm" style="font-size:0.65rem;">SM ✓</span>';
                        }
                        if (team.developerCount > 0) {
                            statusHtml += `<span class="badge badge-role role-dev" style="font-size:0.65rem;">${team.developerCount} Dev</span>`;
                        }
                        statusHtml += '</div>';
                        
                        return `
                            <div class="content-card mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="fw-bold text-dark mb-1">${team.name}</h6>
                                        <small class="text-muted">${team.currentMemberCount}/${team.maxMembers} membros</small>
                                    </div>
                                    ${statusHtml}
                                </div>
                                <div class="border-top pt-2 mt-2">
                                    <small class="text-muted d-block mb-1">Escolhe o teu role:</small>
                                    ${rolesHtml}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    lucide.createIcons();
                })
                .catch(error => {
                    console.error('Error loading teams:', error);
                });
        }

        function joinTeamWithRole(teamId, role) {
            fetch('/api/teams/' + teamId + '/join', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ studentId: window.currentStudentId, role: role })
            })
            .then(response => {
                if (response.ok) {
                    let roleText = role === 'PRODUCT_OWNER' ? 'Product Owner' : (role === 'SCRUM_MASTER' ? 'Scrum Master' : 'Developer');
                    sessionStorage.setItem('teamSuccessMessage', 'Juntaste-te à equipa como ' + roleText + '!');
                    window.location.reload();
                } else {
                    return response.json().then(err => { throw new Error(err.error || err.message); });
                }
            })
            .catch(error => {
                sessionStorage.setItem('teamErrorMessage', 'Erro ao juntar-se à equipa: ' + error.message);
                window.location.reload();
            });
        }

        function joinTeam(teamId) {
            joinTeamWithRole(teamId, 'DEVELOPER');
        }

        function addStudentDeveloperField() {
            const container = document.getElementById('student-developers-container');
            const rows = container.querySelectorAll('.student-developer-row');
            
            if (rows.length >= 8) {
                alert('Máximo de 8 developers permitidos');
                return;
            }

            const firstRow = container.querySelector('.student-developer-row');
            const newRow = firstRow.cloneNode(true);
            const select = newRow.querySelector('select');
            select.value = "";

            if (!newRow.querySelector('.btn-remove')) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-light border-0 text-danger ms-2 btn-remove';
                removeBtn.innerHTML = '<i data-lucide="trash-2" style="width:16px;"></i>';
                removeBtn.onclick = function() { this.parentElement.remove(); updateStudentTeamOptions(); };
                newRow.appendChild(removeBtn);
            }
            container.appendChild(newRow);
            lucide.createIcons();
            updateStudentTeamOptions();
        }

        function updateStudentTeamOptions() {
            const form = document.getElementById('studentCreateTeamForm');
            if (!form) return;
            
            const selects = form.querySelectorAll('.student-member-select');
            const selectedValues = new Set();

            selects.forEach(select => {
                if (select.value) selectedValues.add(select.value);
            });

            selects.forEach(select => {
                const options = select.querySelectorAll('option');
                const myValue = select.value;
                options.forEach(opt => {
                    if (selectedValues.has(opt.value) && opt.value !== myValue) {
                        opt.disabled = true;
                    } else {
                        opt.disabled = false;
                    }
                });
            });

            // Update add developer button state
            const container = document.getElementById('student-developers-container');
            const rows = container.querySelectorAll('.student-developer-row');
            const addBtn = document.getElementById('addStudentDeveloperBtn');
            if (rows.length >= 8) {
                addBtn.disabled = true;
                addBtn.classList.add('opacity-50');
            } else {
                addBtn.disabled = false;
                addBtn.classList.remove('opacity-50');
            }
        }

        function loadCoursematesForTeamCreation(courseId) {
            fetch('/api/teams/course-mates/' + courseId)
                .then(response => response.json())
                .then(data => {
                    const students = data.students || [];
                    const teacher = data.teacher;
                    
                    const poSelect = document.querySelector('select[name="productOwnerId"]');
                    const smSelect = document.querySelector('select[name="scrumMasterId"]');
                    const devSelects = document.querySelectorAll('select[name="developerIds"]');
                    
                    // Clear existing options (except the first placeholder)
                    [poSelect, smSelect].forEach(select => {
                        while (select.options.length > 1) {
                            select.remove(1);
                        }
                    });
                    
                    // Clear developer select
                    const devSelect = devSelects[0];
                    while (devSelect.options.length > 1) {
                        devSelect.remove(1);
                    }
                    
                    // Add teacher first for Product Owner (if available)
                    if (teacher) {
                        const teacherOption = document.createElement('option');
                        teacherOption.value = teacher.id;
                        teacherOption.text = 'Prof. ' + teacher.name + ' (Professor)';
                        poSelect.add(teacherOption);
                    }
                    
                    // Add current student to Product Owner
                    const currentStudentOptionPO = document.createElement('option');
                    currentStudentOptionPO.value = window.currentStudentId;
                    currentStudentOptionPO.text = /*[[${student.studentTag}]]*/ '' + ' - ' + /*[[${student.name}]]*/ '' + ' (Tu)';
                    poSelect.add(currentStudentOptionPO);
                    
                    // Add current student to Scrum Master
                    const currentStudentOptionSM = document.createElement('option');
                    currentStudentOptionSM.value = window.currentStudentId;
                    currentStudentOptionSM.text = /*[[${student.studentTag}]]*/ '' + ' - ' + /*[[${student.name}]]*/ '' + ' (Tu)';
                    smSelect.add(currentStudentOptionSM);
                    
                    // Add coursemates to all selects
                    students.forEach(student => {
                        if (student.id !== window.currentStudentId) {
                            const option1 = document.createElement('option');
                            option1.value = student.id;
                            option1.text = student.studentTag + ' - ' + student.name;
                            poSelect.add(option1);
                            
                            const option2 = document.createElement('option');
                            option2.value = student.id;
                            option2.text = student.studentTag + ' - ' + student.name;
                            smSelect.add(option2);
                        }
                    });
                    
                    // For developers, add current student first
                    const currentDevOption = document.createElement('option');
                    currentDevOption.value = window.currentStudentId;
                    currentDevOption.text = /*[[${student.studentTag}]]*/ '' + ' - ' + /*[[${student.name}]]*/ '' + ' (Tu)';
                    devSelect.add(currentDevOption);
                    
                    // Add other students to developers
                    students.forEach(student => {
                        if (student.id !== window.currentStudentId) {
                            const option = document.createElement('option');
                            option.value = student.id;
                            option.text = student.studentTag + ' - ' + student.name;
                            devSelect.add(option);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading coursemates:', error);
                });
        }

        // Validate student team form before submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('studentCreateTeamForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const poId = form.querySelector('select[name="productOwnerId"]').value;
                    const smId = form.querySelector('select[name="scrumMasterId"]').value;
                    const devIds = Array.from(form.querySelectorAll('select[name="developerIds"]'))
                        .map(s => s.value)
                        .filter(v => v !== "");
                    
                    // Collect all selected members (filter out empty values)
                    const allMembers = [poId, smId, ...devIds].filter(v => v !== "");
                    
                    // Check for duplicates only among selected members
                    if (allMembers.length > 0 && new Set(allMembers).size !== allMembers.length) {
                        alert('Não pode haver membros duplicados!');
                        e.preventDefault();
                        return;
                    }
                    
                    if (allMembers.length > 10) {
                        alert('A equipa não pode ter mais de 10 membros!');
                        e.preventDefault();
                    }
                });
            }
        });
    </script>

    <nav class="navbar-student d-flex justify-content-between align-items-center p-3 sticky-top">
        <div class="d-flex align-items-center gap-3">
            <div class="bg-success text-white p-2 rounded-3 shadow-sm"><i data-lucide="graduation-cap" style="width: 24px; height: 24px;"></i></div>
            <div><h5 class="mb-0 fw-bold" style="color: #2c3e50;">EduScrum</h5><small class="text-muted">Área do Estudante</small></div>
        </div>
        <div class="d-flex align-items-center gap-4">
            <div id="notificationBellContainer" class="position-relative cursor-pointer p-2 rounded-circle hover-bg-light" onclick="toggleNotificationSidebar()">
                <i id="notificationBellIcon" data-lucide="bell" class="text-secondary"></i>
                <span id="notificationCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem; display: none;">0</span>
            </div>
            <div class="vr text-muted opacity-25" style="height: 30px;"></div>
            <div class="dropdown">
                <a href="#" class="profile-trigger text-decoration-none d-flex align-items-center gap-3" data-bs-toggle="dropdown">
                    <div class="text-end d-none d-md-block">
                        <div class="profile-name fw-bold text-dark" th:text="${student.name}">Aluno</div>
                        <div class="profile-email small text-muted" th:text="${student.email}">email@upt.pt</div>
                    </div>
                    <img th:if="${student.profileImage != null}" th:src="@{'/uploads/profile-images/' + ${student.profileImage}}" class="rounded-circle shadow-sm border" style="width: 42px; height: 42px; object-fit: cover;">
                    <div th:unless="${student.profileImage != null}" class="profile-avatar bg-success text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm" style="width: 42px; height: 42px; font-size: 1.2rem;" th:text="${#strings.substring(student.name,0,1)}">A</div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-3 mt-2">
                    <li><a class="dropdown-item py-2" href="#" data-bs-toggle="modal" data-bs-target="#editStudentProfileModal"><i data-lucide="user" class="w-4 h-4 inline me-2 opacity-50"></i> Editar Perfil</a></li>
                    <li>
                        <a class="dropdown-item py-2" href="#" data-bs-toggle="modal" data-bs-target="#settingsModal">
                            <i data-lucide="settings" class="w-4 h-4 inline me-2 opacity-50"></i> Configurações
                        </a>
                    </li>
                    <li><hr class="dropdown-divider my-2"></li>
                    <li><a class="dropdown-item py-2 text-danger" th:href="@{/logout}"><i data-lucide="log-out" class="w-4 h-4 inline me-2 opacity-50"></i> Sair</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="notificationSidebar" class="notification-sidebar">
        <div class="notification-sidebar-header">
            <h5 class="fw-bold mb-0" onclick="toggleNotificationSidebar()">Notificações</h5>
            <button type="button" class="btn-close" aria-label="Close" onclick="toggleNotificationSidebar()"></button>
        </div>
        <div class="notification-sidebar-body">
            <div id="notificationsContainer">
                <div class="text-center text-muted mt-4" id="noNotifications" style="display: none;">
                    <i data-lucide="bell-off" class="w-8 h-8 mb-2"></i>
                    <p>Nenhuma notificação nova.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-3" style="max-width: 1200px;">
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show shadow-sm border-0" role="alert" style="background-color: #d1e7dd; color: #0f5132;">
            <i data-lucide="check-circle" class="w-5 h-5 inline me-2"></i><span th:text="${successMessage}">Sucesso!</span><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show shadow-sm border-0" role="alert" style="background-color: #f8d7da; color: #842029;">
            <i data-lucide="alert-circle" class="w-5 h-5 inline me-2"></i><span th:text="${errorMessage}">Erro!</span><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <div class="tabs-container shadow-sm">
        <button class="tab-btn active" onclick="openTab('overview', this)"><i data-lucide="layout-dashboard" class="inline-block w-4 h-4 me-2"></i>Visão Geral</button>
        <button class="tab-btn" onclick="openTab('all-courses', this)"><i data-lucide="book-open" class="inline-block w-4 h-4 me-2"></i>Cursos</button>
        <button class="tab-btn" onclick="openTab('my-awards', this)"><i data-lucide="award" class="inline-block w-4 h-4 me-2"></i>Meus Prémios</button>
        <button class="tab-btn" onclick="openTab('projects', this)"><i data-lucide="folder-kanban" class="inline-block w-4 h-4 me-2"></i>Projetos</button>
    </div>

    <div class="container pb-5" style="max-width: 1200px;">

        <div id="overview" class="tab-content active">
            
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="text-muted small fw-bold">Pontuação Total</span>
                            <i data-lucide="trophy" class="text-warning" style="width: 20px;"></i>
                        </div>
                        <h2 class="fw-bold mb-1 text-dark" style="font-size: 2.5rem;" th:text="${student.totalPoints}">850</h2>
                        <small class="text-muted">+5% vs média</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="text-muted small fw-bold">Ranking</span>
                            <i data-lucide="trending-up" class="text-primary" style="width: 20px;"></i>
                        </div>
                        <h2 class="fw-bold mb-1 text-dark" style="font-size: 2.5rem;" th:text="'#' + ${student.currentRank}">#5</h2>
                        <small class="text-muted" th:text="'de ' + (${studentCount} ?: 0) + ' estudantes'">de 30 estudantes</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="text-muted small fw-bold">Prémios Ganhos</span>
                            <i data-lucide="medal" class="text-purple-500" style="color: #a855f7; width: 20px;"></i>
                        </div>
                        <h2 class="fw-bold mb-1 text-dark" style="font-size: 2.5rem;" th:text="${student.earnedAwards != null ? #lists.size(student.earnedAwards) : 0}">1</h2>
                        <small class="text-muted">pontos acumulados</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="text-muted small fw-bold">Equipas Ativas</span>
                            <i data-lucide="users" class="text-success" style="width: 20px;"></i>
                        </div>
                        <h2 class="fw-bold mb-1 text-dark" style="font-size: 2.5rem;" th:text="${student.projects != null ? #lists.size(student.projects) : 0}">2</h2>
                        <small class="text-muted">projetos</small>
                    </div>
                </div>
            </div>

            <div class="stat-card mb-4" style="height: auto;">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <i data-lucide="line-chart" class="text-dark" style="width: 18px;"></i>
                    <h6 class="fw-bold mb-0">Evolução de Pontuação</h6>
                </div>
                <p class="text-muted small mb-4">Progressão acumulada dos seus pontos ao longo do tempo</p>
                
                <div style="height: 300px; width: 100%;">
                    <canvas id="scoreEvolutionChart"></canvas>
                </div>
            </div>

            <div class="row g-4 mb-5">
                
                <div class="col-md-6">
                    <div class="stat-card">
                        <div class="d-flex align-items-center gap-2 mb-4">
                            <i data-lucide="bar-chart-2" class="text-dark" style="width: 18px;"></i>
                            <h6 class="fw-bold mb-0">Comparação com a Turma</h6>
                        </div>
                        <p class="text-muted small mt-n3 mb-4">Seu desempenho vs média</p>

                        <div class="comparison-row comp-user">
                            <span>Sua Pontuação</span>
                            <span class="fw-bold" th:text="${student.totalPoints} + ' pts'">850 pts</span>
                        </div>

                        <div class="comparison-row comp-avg">
                            <span>Média da Turma</span>
                            <span class="fw-bold" th:text="${#numbers.formatDecimal(student.classAverage, 1, 0)} + ' pts'">810 pts</span>
                        </div>

                        <div class="comparison-row comp-diff">
                            <span>Diferença</span>
                            <span class="fw-bold" th:text="${(student.totalPoints - student.classAverage) >= 0 ? '+' + #numbers.formatDecimal(student.totalPoints - student.classAverage, 1, 0) + ' pts' : #numbers.formatDecimal(student.totalPoints - student.classAverage, 1, 0) + ' pts'}">+40 pts</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-3 pt-3">
                            <span class="text-muted small">Percentil</span>
                            <span class="badge bg-primary px-3 py-2 rounded-pill">Top 20%</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="stat-card">
                        <div class="d-flex align-items-center gap-2 mb-4">
                            <i data-lucide="trophy" class="text-warning" style="width: 18px;"></i>
                            <h6 class="fw-bold mb-0">Top 5 Estudantes</h6>
                        </div>
                        <p class="text-muted small mt-n3 mb-4">Melhores classificações da turma</p>

                        <div class="d-flex flex-column gap-2">
                            <div th:each="topStudent, iter : ${student.topStudents}" 
                                 class="ranking-item"
                                 th:classappend="${iter.index == 0 ? 'rank-gold' : (iter.index == 1 ? 'rank-silver' : (iter.index == 2 ? 'rank-bronze' : 'rank-normal'))}">
                                
                                <div class="d-flex align-items-center">
                                    <div class="rank-badge" th:text="${iter.index + 1}">1</div>
                                    <span th:text="${topStudent.name}">Ana</span>
                                    <i th:if="${iter.index == 0}" data-lucide="crown" class="w-4 h-4 ms-2 text-warning-dark" style="fill: #fbc02d; stroke: none;"></i>
                                </div>
                                <span class="fw-bold" th:text="${topStudent.totalPoints} + ' pts'">920 pts</span>
                            </div>

                            <div class="ranking-item rank-me mt-2">
                                <div class="d-flex align-items-center">
                                    <div class="rank-badge text-primary" th:text="${student.currentRank}">5</div>
                                    <span>Você</span>
                                </div>
                                <span class="fw-bold text-primary" th:text="${student.totalPoints} + ' pts'">850 pts</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <h5 class="fw-bold mb-3">Prémios Recentes</h5>
                <div class="row g-3">
                    <div class="col-md-4" th:each="award, iter : ${student.earnedAwards}" th:if="${iter.index < 3}"> <div class="d-flex align-items-center gap-3 p-3 border rounded-3 bg-light bg-opacity-25">
                            <div class="bg-white p-2 rounded shadow-sm">
                                <i data-lucide="award" class="w-6 h-6 text-warning"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-0 text-dark" th:text="${award.name}">Nome</h6>
                                <small class="text-muted" th:text="${award.description}">Desc</small>
                            </div>
                            <div class="ms-auto fw-bold text-primary" th:text="'+' + ${award.points}">+0</div>
                        </div>
                    </div>
                    <div th:if="${#lists.isEmpty(student.earnedAwards)}" class="col-12 text-center text-muted py-2">Sem prémios recentes.</div>
                </div>
            </div>
        </div>

        <div id="all-courses" class="tab-content">
            <div class="d-flex justify-content-between align-items-center mb-4"><div><h3 class="fw-bold mb-1 text-primary">Meus Cursos</h3><p class="text-muted">Cursos em que estás atualmente inscrito.</p></div></div>
            <div class="row g-3">
                <div class="col-md-6" th:each="course : ${student.enrolledCourses}">
                    <div class="content-card h-100 border-start border-4 border-primary">
                        <div class="d-flex justify-content-between align-items-start"><div><h5 class="fw-bold text-dark mb-1" th:text="${course.name}">Nome</h5><span class="badge bg-primary bg-opacity-10 text-primary rounded-pill mb-2" th:text="${course.tag}">TAG</span><p class="text-muted small mb-0" th:text="${course.description}">Desc</p></div><i data-lucide="check-circle" class="text-primary" style="width: 24px; height: 24px;"></i></div>
                        <div class="mt-3 pt-3 border-top d-flex justify-content-between align-items-center"><small class="text-muted fw-bold">Inscrito</small><button class="btn btn-sm btn-outline-primary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#courseDetailsModal" th:data-course-id="${course.id}" th:data-course-name="${course.name}" onclick="setupCourseDetailsModal(this)">Ver Detalhes</button></div>
                    </div>
                </div>
                <div th:if="${#lists.isEmpty(student.enrolledCourses)}" class="col-12 text-center py-4 bg-white rounded-3 border border-dashed"><p class="text-muted mb-0">Não estás inscrito em nenhum curso.</p></div>
            </div>
            <hr class="my-5 opacity-25">
            <div class="d-flex justify-content-between align-items-center mb-4"><div><h4 class="fw-bold mb-1 text-secondary">Outros Cursos Disponíveis</h4></div></div>
            <div class="row g-3">
                <div class="col-md-4" th:each="course : ${student.availableCourses}">
                    <div class="content-card h-100 bg-light bg-opacity-50">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="fw-bold text-dark mb-0" th:text="${course.name}">Nome</h6>
                            <span class="badge bg-secondary bg-opacity-10 text-secondary" th:text="${course.tag}">TAG</span>
                        </div>
                        <p class="text-muted small mb-3" th:text="${#strings.abbreviate(course.description, 50)}">Desc</p>
                    <button class="btn btn-sm btn-outline-primary rounded-pill w-100 shadow-sm fw-bold transition hover-scale"
                            type="button"
                            data-bs-toggle="modal" 
                            data-bs-target="#enrollModal"
                            th:data-id="${course.id}"
                            th:data-name="${course.name}"
                            onclick="setupEnrollModal(this)">
                        Inscrever-se</button>
                </div>
            </div>
        </div>
    </div>
        <div id="my-awards" class="tab-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="fw-bold mb-1">Todos os Prémios</h3>
                    <p class="text-muted">Histórico completo dos seus prémios</p>
                </div>
                <div class="bg-white px-4 py-2 rounded-pill shadow-sm border d-flex align-items-center gap-2">
                    <span class="text-muted small fw-bold text-uppercase">Total</span>
                    <span class="fw-bold text-primary" style="font-size: 1.2rem;" th:text="${student.totalPoints} + ' pts'">0 pts</span>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6" th:each="award : ${student.earnedAwards}">
                    <div class="content-card h-100 p-4 border hover-shadow transition" 
                         style="border-left: 5px solid #ffc107 !important;"> <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex gap-3">
                                <div class="rounded-3 d-flex align-items-center justify-content-center" 
                                     style="width: 50px; height: 50px; background-color: #fff9c4;">
                                    <i data-lucide="trophy" class="text-warning" style="width: 24px; height: 24px;"></i>
                                </div>
                                <div>
                                    <h5 class="fw-bold text-dark mb-1" th:text="${award.name}">Innovation Hero</h5>
                                    <p class="text-muted small mb-0" th:text="${award.description}">Implementação de features inovadoras</p>
                                </div>
                            </div>
                            <span class="badge bg-light text-dark border fw-bold" th:text="${award.type}">Manual</span>
                        </div>

                        <div class="d-flex align-items-center justify-content-between mt-3 pt-3 border-top border-light">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-warning bg-opacity-25 text-warning-dark fw-bold px-3 py-1 rounded-pill" 
                                      style="color: #b45309;" 
                                      th:text="'+' + ${award.points} + ' pontos'">+150 pontos</span>
                            </div>
                            <small class="text-muted fst-italic">Atribuído recentemente</small>
                        </div>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(student.earnedAwards)}" class="col-12">
                    <div class="text-center py-5 content-card bg-light border-dashed">
                        <div class="mb-3 p-3 bg-white rounded-circle d-inline-block shadow-sm">
                            <i data-lucide="award" class="w-8 h-8 text-muted opacity-50"></i>
                        </div>
                        <h6 class="fw-bold text-muted">Ainda não tens prémios.</h6>
                        <p class="text-muted small mb-0">Continua o bom trabalho para desbloquear conquistas!</p>
                    </div>
                </div>
            </div>

            <!-- Prémios que podem ser obtidos -->
            <div class="mt-4">
                <h5 class="fw-bold mb-3">Prémios que podem ser obtidos</h5>
                <div class="row g-3">
                    <div class="col-md-4" th:each="award : ${student.unearnedAwards}">
                        <div class="content-card h-100 p-4 border hover-shadow transition" style="opacity: 0.6; filter: grayscale(100%);">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="d-flex gap-3">
                                    <div class="rounded-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; background-color: #f8f9fa;">
                                        <i data-lucide="lock" class="text-muted" style="width: 24px; height: 24px;"></i>
                                    </div>
                                    <div>
                                        <h5 class="fw-bold text-muted mb-1" th:text="${award.name}">Nome</h5>
                                        <p class="text-muted small mb-0" th:text="${award.description}">Desc</p>
                                    </div>
                                </div>
                                <span class="badge bg-light text-muted border fw-bold" th:text="${award.type}">Manual</span>
                            </div>

                            <div class="d-flex align-items-center justify-content-between mt-3 pt-3 border-top border-light">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-light text-muted border fw-bold px-3 py-1 rounded-pill" th:text="'+' + ${award.points} + ' pontos'">+150 pontos</span>
                                </div>
                                <small class="text-muted fst-italic">Não desbloqueado</small>
                            </div>
                        </div>
                    </div>
                    <div th:if="${#lists.isEmpty(student.unearnedAwards)}" class="col-12 text-center text-muted py-2">
                        Nenhum prémio disponível no momento.
                    </div>
                </div>
            </div>
        </div>
        
        <div id="projects" class="tab-content">
            
            <div th:if="${student.projects != null}" th:each="project : ${student.projects}" class="content-card mb-4 border-0 shadow-sm">
                
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div class="d-flex gap-3">
                        <div class="mt-1">
                            <div class="rounded-circle" 
                                 th:classappend="${project.status.name() == 'CONCLUIDO' ? 'bg-success' : (project.status.name() == 'EM_CURSO' ? 'bg-warning' : 'bg-secondary')}"
                                 style="width: 12px; height: 12px;"></div>
                        </div>
                        <div>
                            <h4 class="fw-bold text-dark mb-1" th:text="${project.name}">Sistema de Gestão Académica</h4>
                            <p class="text-muted mb-2 small" th:text="${project.sprintGoals}">Plataforma para gestão de estudantes e cursos</p>
                            
                            <div class="d-flex gap-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10" th:if="${project.courseName != null}" th:text="${project.courseName}">Qualidade de Software</span>
                                <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10" th:if="${project.courseName == null}">Curso não disponível</span>
                                <span class="badge bg-purple-100 text-purple-700 border border-purple-200" style="background-color: #f3e8ff; color: #7e22ce;" th:text="${student.roleInTeam}">Scrum Master</span>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <!-- Botão Concluir: aparece quando status NÃO é CONCLUIDO e todos os sprints estão concluídos -->
                        <button th:if="${project.status.name() != 'CONCLUIDO' and project.sprints != null and !#lists.isEmpty(project.sprints)}" 
                                class="btn btn-sm btn-success rounded-pill px-3 align-items-center gap-1 complete-project-btn"
                                data-bs-toggle="modal" 
                                data-bs-target="#completeProjectModal"
                                th:data-project-id="${project.id}"
                                onclick="setupCompleteProjectModal(this)"
                                style="display: none !important;">
                            <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
                            <span>Concluir Projeto</span>
                        </button>
                        
                        <!-- Botão Reabrir: aparece quando status É CONCLUIDO -->
                        <button th:if="${project.status.name() == 'CONCLUIDO'}" 
                                class="btn btn-warning btn-sm rounded-pill px-3 d-flex align-items-center gap-1"
                                data-bs-toggle="modal" 
                                data-bs-target="#reopenProjectModal"
                                th:data-project-id="${project.id}"
                                onclick="setupReopenProjectModal(this)">
                            <i data-lucide="rotate-ccw" style="width: 14px; height: 14px;"></i>
                            <span>Reabrir Projeto</span>
                        </button>
                        
                        <span class="badge text-white px-3 py-2 rounded-pill"
                              th:classappend="${project.status.name() == 'CONCLUIDO' ? 'bg-success' : (project.status.name() == 'EM_CURSO' ? 'bg-warning' : 'bg-secondary')}"
                              th:text="${#strings.replace(project.status.name(), '_', ' ')}">Ativo</span>
                    </div>
                </div>
                
                <!-- Hidden inputs com datas do projeto e último sprint para validação JS -->
                <input type="hidden" th:id="'projectStartDateHidden-' + ${project.id}" th:value="${project.startDate}" />
                <input type="hidden" th:id="'projectEndDateHidden-' + ${project.id}" th:value="${project.endDate}" />
                <input type="hidden" th:if="${project.sprints != null and !#lists.isEmpty(project.sprints)}" th:id="'lastSprintEndHidden-' + ${project.id}" th:value="${project.sprints[#lists.size(project.sprints) - 1].endDate}" />

                <div class="mb-4">
                    <h6 class="text-muted small fw-bold text-uppercase mb-2"><i data-lucide="users" class="w-3 h-3 inline me-1"></i> Equipa <span th:text="${student.teamName}">Alpha</span></h6>
                    <div class="d-flex flex-column gap-2">
                        <div th:each="member : ${project.members}" 
                             class="d-flex justify-content-between align-items-center p-3 bg-light rounded-3 border">
                            <div class="d-flex align-items-center gap-3">
                                <div>
                                    <div th:if="${userProfileImageMap[member.id] != null}">
                                        <img th:src="@{'/uploads/profile-images/' + ${userProfileImageMap[member.id]}}" th:alt="${member.name}" class="rounded-circle" style="width:42px; height:42px; object-fit:cover;" />
                                    </div>
                                    <div th:unless="${userProfileImageMap[member.id] != null}" class="text-white rounded-circle d-flex align-items-center justify-content-center fw-bold" 
                                         style="width: 42px; height: 42px;"
                                         th:style="${member.role == 'Product Owner'} ? 'width:42px; height:42px; background-color:#0d6efd;' : (${member.role == 'Scrum Master'} ? 'width:42px; height:42px; background-color:#6f42c1;' : 'width:42px; height:42px; background-color:#198754;')"
                                         th:text="${#strings.substring(member.name, 0, 1).toUpperCase()}">J</div>
                                </div>
                                <div>
                                    <h6 class="fw-bold text-dark mb-0" th:text="${member.name}">Utilizador</h6>
                                    <span class="badge badge-role" 
                                          th:classappend="${member.role == 'Product Owner'} ? 'role-po' : (${member.role == 'Scrum Master'} ? 'role-sm' : 'role-dev')"
                                          th:text="${member.role}">Developer</span>
                                </div>
                            </div>
                            <div class="d-flex gap-3 align-items-center">
                                <div class="text-end">
                                    <div class="small text-muted">Prémios</div>
                                    <div class="fw-bold text-dark" th:text="${member.awardsCount}">0</div>
                                </div>
                                <div class="text-end">
                                    <div class="small text-muted">XP</div>
                                    <div class="fw-bold text-primary" th:text="${member.individualXP}">0</div>
                                </div>
                            </div>
                        </div>
                        <div th:if="${#lists.isEmpty(project.members)}" class="text-muted small">Nenhum membro na equipa.</div>
                    </div>
                </div>

                <div class="mb-5">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted small fw-bold">Progresso Geral</span>
                        <span class="small fw-bold" 
                              th:classappend="${project.status.name() == 'CONCLUIDO'} ? 'text-success' : 'text-primary'"
                              th:text="${project.progress} + '%'">88%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar rounded-pill" 
                             th:classappend="${project.status.name() == 'CONCLUIDO'} ? 'bg-success' : 'bg-primary'"
                             role="progressbar" 
                             th:style="'width: ' + ${project.progress} + '%'"></div>
                    </div>
                </div>

                <div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0 d-flex align-items-center">
                            <i data-lucide="layers" class="w-4 h-4 me-2 text-dark"></i> Sprints (<span th:text="${project.sprints != null ? #lists.size(project.sprints) : 0}">0</span>)
                        </h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary rounded-pill px-3 d-flex align-items-center gap-1"
                                    th:if="${project.status.name() != 'CONCLUIDO'}"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#newSprintModal"
                                    th:attr="data-project-id=${project.id}"
                                    onclick="setupNewSprintModal(this)">
                                <i data-lucide="plus" style="width: 14px; height: 14px;"></i>
                                <span>Nova Sprint</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="d-flex flex-column gap-3 sprints-container">
                        <div th:each="sprint, iterStat : ${project.sprints}" class="sprint-item d-flex align-items-center justify-content-between p-3 bg-light rounded-3 border-start border-4 hover-shadow transition cursor-pointer"
                             th:classappend="${sprint.status?.name() == 'CONCLUIDO'} ? 'border-success' : 'border-primary'"
                             th:data-status="${sprint.status?.name()}"
                             th:onclick="|window.location.href='/view/sprint/${sprint.id}/user/${student.id}'|">
                            
                            <div class="d-flex align-items-center gap-3 flex-grow-1">
                                <i th:if="${sprint.status?.name() == 'CONCLUIDO'}" data-lucide="check-circle-2" class="text-success w-5 h-5"></i>
                                <i th:if="${sprint.status?.name() != 'CONCLUIDO'}" data-lucide="circle-dashed" class="text-primary w-5 h-5"></i>
                                
                                <div class="flex-grow-1">
                                    <h6 class="mb-0 fw-bold text-dark" th:text="'Sprint ' + ${iterStat.count} + ' - ' + ${sprint.name}">Sprint 1 - Nome</h6>
                                    <small class="text-muted" th:text="${sprint.startDate} + ' - ' + ${sprint.endDate}">Datas</small>
                                </div>
                            </div>

                            <div class="d-flex align-items-center gap-3">
                                <div class="progress" style="width: 150px; height: 6px;">
                                    <div class="progress-bar rounded-pill" 
                                         th:classappend="${sprint.status?.name() == 'CONCLUIDO'} ? 'bg-success' : 'bg-primary'"
                                         role="progressbar" 
                                         th:style="'width: ' + ${sprint.progress} + '%'"></div>
                                </div>
                                <span class="small fw-bold" 
                                      th:classappend="${sprint.status?.name() == 'CONCLUIDO'} ? 'text-success' : 'text-primary'"
                                      style="min-width: 45px;"
                                      th:text="${sprint.progress} + '%'">100%</span>
                                <i data-lucide="chevron-right" class="text-muted" style="width: 20px; height: 20px;"></i>
                            </div>
                        </div>
                        
                        <div th:if="${#lists.isEmpty(project.sprints)}" class="text-muted small text-center py-3">
                            Nenhuma sprint criada neste projeto. Clique em "Nova Sprint" para começar.
                        </div>
                    </div>
                </div>
            </div>

            <div th:if="${student.projects == null || #lists.isEmpty(student.projects)}" class="alert alert-info content-card border-info border-opacity-25 bg-info bg-opacity-10 text-info fw-bold d-flex align-items-center gap-3 p-4">
                <div class="bg-white p-2 rounded-circle shadow-sm">
                    <i data-lucide="info" class="w-6 h-6 text-info"></i>
                </div>
                <div>
                    <h6 class="mb-1 text-dark">Sem Projetos Ativos</h6>
                    <p class="mb-0 fw-normal small text-muted">Atualmente não estás associado a nenhum projeto. Fala com o teu professor para te juntares a uma equipa.</p>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="editStudentProfileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold">Editar Perfil</h4>
                        <p class="text-muted small mb-0">Atualiza os teus dados e foto.</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm" th:action="@{/api/student/profile/update}" method="POST" enctype="multipart/form-data">
                        
                        <input type="hidden" name="id" th:value="${student.id}" /> 
                        
                        <div class="mb-4 text-center">
                            <div class="position-relative d-inline-block" style="width: fit-content;">
                                <div class="position-relative" style="width: 120px; height: 120px; margin: 0 auto;">
                                    <img id="profileImagePreview" 
                                         th:src="@{${student.profileImage != null} ? '/uploads/profile-images/' + ${student.profileImage} : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22%3E%3C/svg%3E'}"
                                         class="rounded-circle border-4 border-primary shadow-lg position-absolute" 
                                         th:style="${student.profileImage != null} ? 'width: 100%; height: 100%; object-fit: cover; display: block; transition: display 0.3s ease; top: 0; left: 0; z-index: 10;' : 'width: 100%; height: 100%; object-fit: cover; display: none; transition: display 0.3s ease; top: 0; left: 0; z-index: 10;'"
                                         style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; transition: display 0.3s ease; z-index: 10;">
                                    
                                    <div id="profileImagePlaceholder"
                                         th:style="${student.profileImage != null} ? 'width: 100%; height: 100%; background: linear-gradient(135deg, #f0f7ff 0%, #e0e7ff 100%); display: none; position: absolute; top: 0; left: 0; z-index: 1;' : 'width: 100%; height: 100%; background: linear-gradient(135deg, #f0f7ff 0%, #e0e7ff 100%); display: flex; position: absolute; top: 0; left: 0; z-index: 1;'"
                                         class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-circle border-4 border-primary d-flex justify-content-center align-items-center" 
                                         style="transition: display 0.3s ease;">
                                        <i data-lucide="user" class="w-12 h-12 text-primary opacity-30"></i>
                                    </div>

                                    <label for="imageUploadStudent" class="position-absolute bottom-0 end-0 bg-success text-white rounded-circle shadow-lg cursor-pointer transition" 
                                           style="width: 42px; height: 42px; display: flex; justify-content: center; align-items: center; transform: translate(6px, 6px); border: 3px solid white; z-index: 20;"
                                           title="Clique para alterar foto">
                                        <i data-lucide="camera" class="w-5 h-5"></i>
                                        <input type="file" id="imageUploadStudent" name="imageFile" accept="image/*" class="d-none">
                                    </label>

                                    <button type="button" id="removeImageBtn"
                                            class="position-absolute top-0 end-0 bg-danger text-white rounded-circle shadow-lg cursor-pointer transition" 
                                            th:style="${student.profileImage != null} ? 'width: 42px; height: 42px; display: flex; justify-content: center; align-items: center; transform: translate(6px, -6px); border: 3px solid white; padding: 0; transition: display 0.3s ease; z-index: 20;' : 'width: 42px; height: 42px; display: none; justify-content: center; align-items: center; transform: translate(6px, -6px); border: 3px solid white; padding: 0; transition: display 0.3s ease; z-index: 20;'"
                                            title="Clique para remover foto"
                                            onclick="removeProfileImage(event)">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-4 p-3 bg-blue-50 rounded-3 border border-blue-200" style="background-color: #f0f7ff; border-color: #dbeafe;">
                                <p class="text-muted small mb-1"><strong>Clique na câmara para alterar a foto</strong></p>
                            </div>
                            
                       <div class="row g-3 mb-3">
                            <div class="col-sm-5 col-md-4">
                                <label class="form-label fw-bold small text-muted">Tag (ID)</label>
                                <input type="text" class="form-control border-0 py-2 fw-bold text-muted shadow-none"
                                    th:value="${student.studentTag}" readonly disabled
                                    style="cursor: not-allowed">
                            </div>

                            <div class="col-sm-7 col-md-8">
                                <label class="form-label fw-bold small">Nome Completo</label>
                                <input type="text" name="name" class="form-control bg-light border-0 py-2" th:value="${student.name}" required>
                            </div>
                        </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Email</label>
                            <input type="email" name="email" class="form-control bg-light border-0 py-2" th:value="${student.email}" required>
                        </div>
                        
                        <hr class="my-4 text-muted opacity-25">
                        <h6 class="fw-bold small mb-3">Segurança (opcional)</h6>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Password Atual</label>
                            <input type="password" id="currentPassword" name="currentPassword" class="form-control bg-light border-0 py-2" placeholder="Insira a password atual">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Nova Password</label>
                            <input type="password" id="newPassword" name="newPassword" class="form-control bg-light border-0 py-2" placeholder="Deixa em branco para manter a atual">
                            <div id="newPasswordError" class="text-danger small mt-1" style="display: none;"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Confirmar nova password</label>
                            <input type="password" id="confirmNewPassword" name="confirmNewPassword" class="form-control bg-light border-0 py-2" placeholder="Confirme a nova password">
                            <p id="confirmNewPasswordError" class="text-danger small mt-1" style="display: none;"></p>
                        </div>
                        
                        <div class="modal-footer border-0 pt-4 px-0 pb-0">
                            <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success rounded-pill px-4 fw-bold">Guardar Alterações</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold">Configurações</h4>
                        <p class="text-muted small mb-0">Personalize a sua experiência.</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/api/student/settings}" method="POST">
                        <input type="hidden" name="id" th:value="${student.id}">
                        
                        <div class="p-3 bg-light rounded-3 mb-3 border">
                            <h6 class="fw-bold small mb-3 text-dark">Aparência</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input cursor-pointer" type="checkbox" id="theme-switcher">
                                <label class="form-check-label cursor-pointer" for="theme-switcher">Modo Noturno</label>
                            </div>
                        </div>

                        <div class="p-3 bg-light rounded-3 mb-4 border">
                            <h6 class="fw-bold small mb-3 text-dark">Notificações</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input cursor-pointer" type="checkbox" id="notifAwards" name="notificationAwards" 
                                       th:checked="${student.notificationAwards}">
                                <label class="form-check-label cursor-pointer" for="notifAwards">Prémios atribuídos</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input cursor-pointer" type="checkbox" id="notifRankings" name="notificationRankings" 
                                       th:checked="${student.notificationRankings}">
                                <label class="form-check-label cursor-pointer" for="notifRankings">Alterações no Ranking</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Nome de Exibição</label>
                            <input type="text" name="name" class="form-control bg-light border-0 py-2" th:value="${student.name}" required>
                        </div>

                        <div class="modal-footer border-0 pt-0 px-0">
                            <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">Guardar Preferências</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="enrollModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
            <div class="modal-header border-0 pb-0">
                <div>
                    <h4 class="modal-title fw-bold text-primary">Confirmar Inscrição</h4>
                    <p class="text-muted small mb-0">É necessário um código para entrar.</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <form id="enrollForm" th:action="@{/api/student/enroll}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="studentId" th:value="${student.id}" />
                    <input type="hidden" id="enrollCourseId" name="courseId" />
                    
                    <div class="alert alert-primary bg-primary bg-opacity-10 border-0 d-flex align-items-center mb-4">
                        <i data-lucide="book-open" class="text-primary me-3"></i>
                        <div>
                            <span class="d-block small text-muted text-uppercase fw-bold">Vais entrar em:</span>
                            <span id="enrollCourseName" class="fw-bold h5 text-dark mb-0">Nome do Curso</span>
                        </div>
                    </div>
                    
                    <!-- Mensagem de erro -->
                    <div id="enrollErrorMessage" class="alert alert-danger d-flex align-items-center mb-3" style="display: none !important;">
                        <i data-lucide="alert-circle" class="w-4 h-4 me-2"></i>
                        <span id="enrollErrorText">O código de acesso está incorreto.</span>
                    </div>

                    <div class="mb-3">
                        <label for="accessCode" class="form-label fw-bold small text-dark">Código de Acesso do Curso</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0"><i data-lucide="key" class="w-4 h-4"></i></span>
                            <input type="text" class="form-control bg-light border-0 py-2" 
                                   id="accessCode" name="accessCode" 
                                   placeholder="Insere o código dado pelo professor" required>
                        </div>
                        <div class="form-text small">Se não souberes o código, contacta o professor.</div>
                    </div>

                    <p class="small text-muted mb-0 mt-3"><i data-lucide="info" class="inline w-3 h-3 me-1"></i> Ao inscreveres-te, terás acesso aos projetos e equipas.</p>
                </div>

                <div class="modal-footer border-0 pt-2 px-0 pb-0">
                    <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" id="enrollSubmitBtn" class="btn btn-primary rounded-pill px-4 fw-bold">Validar e Entrar</button>
                </div>
            </form>
        </div>
    </div>
</div>
    
    <!-- Modal Course Details -->
    <div class="modal fade" id="newSprintModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <span id="nextSprintLabel" class="text-muted small fw-bold text-uppercase" style="letter-spacing: 1px;">SPRINT 1</span>
                        <h4 class="modal-title fw-bold mt-1">Nova Sprint</h4>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newSprintForm" th:action="@{/sprints/create}" method="POST">
                        <input type="hidden" id="newSprintProjectId" name="projectId">
                        <input type="hidden" name="studentId" th:value="${student.id}">
                        <!-- Hidden inputs para validação de datas -->
                        <input type="hidden" id="currentProjectStart" value="">
                        <input type="hidden" id="currentProjectEnd" value="">
                        <input type="hidden" id="currentLastSprintEnd" value="">

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Nome da Sprint</label>
                            <input type="text" name="name" class="form-control bg-light border-0 py-2" placeholder="ex: Planeamento Inicial" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Descrição</label>
                            <textarea name="description" class="form-control bg-light border-0" rows="3" placeholder="Objetivos e entregas desta sprint..."></textarea>
                        </div>

                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label fw-bold small">Data Início</label>
                                <input id="sprintStartDate" type="date" name="startDate" class="form-control bg-light border-0 py-2" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold small">Data Fim</label>
                                <input id="sprintEndDate" type="date" name="endDate" class="form-control bg-light border-0 py-2" required>
                            </div>
                        </div>

                        <div class="modal-footer border-0 pt-4 px-0 pb-0">
                            <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">Criar Sprint</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Concluir Projeto -->
    <div class="modal fade" id="completeProjectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold text-success">Concluir Projeto</h4>
                        <p class="text-muted small mb-0">Tem certeza que deseja marcar este projeto como concluído?</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Todos os sprints devem estar concluídos para completar o projeto.</p>
                </div>
                <div class="modal-footer border-0 pt-2 px-0 pb-0">
                    <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="confirmCompleteProjectBtn" class="btn btn-success rounded-pill px-4 fw-bold" onclick="confirmCompleteProject()">
                        <i data-lucide="check-circle" class="w-4 h-4 inline me-1"></i> Concluir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Reabrir Projeto -->
    <div class="modal fade" id="reopenProjectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold text-warning">Reabrir Projeto</h4>
                        <p class="text-muted small mb-0">Tem certeza que deseja reabrir este projeto?</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">O projeto voltará ao estado EM_CURSO.</p>
                </div>
                <div class="modal-footer border-0 pt-2 px-0 pb-0">
                    <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning rounded-pill px-4 fw-bold" onclick="confirmReopenProject()">
                        <i data-lucide="rotate-ccw" class="w-4 h-4 inline me-1"></i> Reabrir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/webjars/bootstrap/5.3.0/js/bootstrap.bundle.min.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script th:inline="javascript">
    // Inicializa ícones Lucide
    lucide.createIcons();

    // ==========================================
    // 1. DADOS GLOBAIS (Backend -> Frontend)
    // ==========================================
    /*<![CDATA[*/
    const currentUserId = /*[[${student.id}]]*/ 0;
    const pointHistory = /*[[${student.pointHistory}]]*/ []; 
    /*]]>*/

    let previewImg = null;
    let hasExistingImage = false;

    // ==========================================
    // 2. SISTEMA DE NOTIFICAÇÕES (ATUALIZADO)
    // ==========================================

    async function fetchNotifications() {
        const notificationsContainer = document.getElementById('notificationsContainer');
        const notificationCountBadge = document.getElementById('notificationCount');
        const notificationBellIcon = document.getElementById('notificationBellIcon');
        const noNotificationsMessage = document.getElementById('noNotifications');

        // Estado de Loading
        notificationsContainer.innerHTML = '<div class="text-center text-muted mt-4"><div class="spinner-border text-primary spinner-border-sm" role="status"></div><p class="mt-2 small">A carregar...</p></div>';
        
        try {
            // Chamada à API Real criada no passo 4
            const response = await fetch(`/api/notifications/${currentUserId}`);
            
            if (!response.ok) {
                // Fallback para log se a API falhar (ex: user logout)
                console.log('API returned ' + response.status);
                throw new Error("Falha ao buscar notificações");
            }
            
            const notifications = await response.json();
            
            // Limpa o container
            notificationsContainer.innerHTML = '';

            if (notifications.length === 0) {
                noNotificationsMessage.style.display = 'block';
                notificationsContainer.appendChild(noNotificationsMessage);
                updateBadge(0);
            } else {
                noNotificationsMessage.style.display = 'none';
                
                notifications.forEach(notification => {
                    const el = createNotificationElement(notification);
                    notificationsContainer.appendChild(el);
                });
                
                // Contar não lidas
                const unreadCount = notifications.filter(n => !n.read).length;
                updateBadge(unreadCount);
            }
            
            lucide.createIcons();

        } catch (error) {
            console.error('Erro notificações:', error);
            // Em caso de erro, limpa o loading e mostra mensagem
            notificationsContainer.innerHTML = '';
            if(noNotificationsMessage) {
                noNotificationsMessage.style.display = 'block';
                notificationsContainer.appendChild(noNotificationsMessage);
            }
        }
    }

    function updateBadge(count) {
        const badge = document.getElementById('notificationCount');
        const icon = document.getElementById('notificationBellIcon');
        
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'block';
            icon.classList.remove('text-secondary');
            icon.classList.add('text-danger');
        } else {
            badge.style.display = 'none';
            icon.classList.remove('text-danger');
            icon.classList.add('text-secondary');
        }
    }

    function createNotificationElement(notification) {
        const item = document.createElement('div');
        item.className = `notification-item ${!notification.read ? 'unread' : ''}`;
        
        let iconName = 'bell';
        let iconBgClass = 'bg-secondary';

        // Mapeamento visual baseado no tipo (Backend Enum)
        switch (notification.type) {
            case 'AWARD':
                iconName = 'trophy';
                iconBgClass = 'bg-warning';
                break;
            case 'TEAM':
                iconName = 'users';
                iconBgClass = 'bg-primary';
                break;
            case 'SPRINT':
                iconName = 'flag';
                iconBgClass = 'bg-success';
                break;
            case 'SYSTEM':
            case 'RANKING':
                iconName = 'info';
                iconBgClass = 'bg-info';
                break;
        }

        item.innerHTML = `
            <div class="notification-icon ${iconBgClass}">
                <i data-lucide="${iconName}" style="width: 18px; height: 18px;"></i>
            </div>
            <div class="notification-content">
                <h6 class="fw-bold mb-1" style="font-size: 0.9rem;">${notification.title}</h6>
                <p class="text-muted small mb-1" style="font-size: 0.8rem; line-height: 1.3;">${notification.message}</p>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <span class="notification-time text-muted" style="font-size: 0.7rem;">
                        ${timeAgo(notification.createdAt)}
                    </span>
                    ${!notification.read ? 
                        `<button class="btn btn-sm btn-link p-0 text-decoration-none" style="font-size: 0.75rem;" onclick="markNotificationAsRead('${notification.id}')">
                            Marcar como lida
                        </button>` : 
                        '<span class="text-success" style="font-size: 0.75rem;"><i data-lucide="check" style="width:12px; display:inline;"></i> Lida</span>'
                    }
                </div>
            </div>
        `;
        return item;
    }

    async function markNotificationAsRead(notificationId) {
        try {
            await fetch(`/api/notifications/${notificationId}/read`, { method: 'POST' });
            fetchNotifications(); // Recarrega a lista para atualizar UI
        } catch (error) {
            console.error('Erro ao marcar como lida:', error);
        }
    }

    function timeAgo(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const seconds = Math.floor((now - date) / 1000);

        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " anos atrás";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " meses atrás";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " dias atrás";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " horas atrás";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " min atrás";
        return "agora mesmo";
    }

    function toggleNotificationSidebar() {
        const sidebar = document.getElementById('notificationSidebar');
        sidebar.classList.toggle('open');
        if (sidebar.classList.contains('open')) {
            fetchNotifications();
        }
    }

    // ==========================================
    // 3. UTILS E MODAIS EXISTENTES (PRESERVADO)
    // ==========================================

    function setupCourseDetails(button) {
        const id = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        const tag = button.getAttribute('data-tag');
        const description = button.getAttribute('data-description');
        const semester = button.getAttribute('data-semester');
        const year = button.getAttribute('data-year');
        const teacher = button.getAttribute('data-teacher');
        const projects = button.getAttribute('data-projects');
        const teams = button.getAttribute('data-teams');

        document.getElementById('courseDetailsTitle').textContent = name || 'Curso';
        document.getElementById('courseDetailsTag').textContent = tag ? tag : '';
        document.getElementById('courseDetailsDescription').textContent = description ? description : 'Sem descrição.';
        document.getElementById('courseDetailsSemester').textContent = semester ? semester : '-';
        document.getElementById('courseDetailsYear').textContent = year ? year : '-';
        document.getElementById('courseDetailsTeacher').textContent = teacher ? ('Prof. ' + teacher) : 'Prof. N/D';
        document.getElementById('courseDetailsProjects').textContent = projects ? projects : '0';
        document.getElementById('courseDetailsTeams').textContent = teams ? teams : '0';
    }

    function setupEnrollModal(button) {
        const courseId = button.getAttribute('data-id');
        const courseName = button.getAttribute('data-name');
        
        document.getElementById('enrollCourseId').value = courseId;
        document.getElementById('enrollCourseName').textContent = courseName;
        
        const codeInput = document.getElementById('accessCode');
        if(codeInput) codeInput.value = '';
        
        const errorDiv = document.getElementById('enrollErrorMessage');
        if(errorDiv) errorDiv.style.setProperty('display', 'none', 'important');
    }

    function removeProfileImage(event) {
        event.preventDefault();
        document.getElementById('removeImage').value = 'true';
        
        const placeholder = document.getElementById('profileImagePlaceholder');
        const removeBtn = document.getElementById('removeImageBtn');
        
        if (previewImg) previewImg.style.display = 'none';
        if (placeholder) placeholder.style.display = 'flex';
        if (removeBtn) removeBtn.style.display = 'none';
        
        const imageInput = document.getElementById('imageUploadStudent');
        if (imageInput) imageInput.value = '';
    }

    function openTab(tabId, btnElement) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btnElement.classList.add('active');
    }

    // ==========================================
    // 3.5 FUNÇÕES DE SPRINT
    // ==========================================

    // Helper functions for date formatting
    function formatDateToYMD(date) {
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    function addDaysYMD(ymd, days) {
        const date = new Date(ymd + 'T00:00:00');
        date.setDate(date.getDate() + days);
        return formatDateToYMD(date);
    }

    function setupNewSprintModal(button) {
        // Usar dataset para aceder ao data-project-id (Thymeleaf gera como data-project-id)
        const projectId = button.dataset.projectId || button.getAttribute('data-project-id');
        console.log('setupNewSprintModal called with projectId:', projectId);
        
        if (!projectId) {
            console.error('projectId is null or undefined!');
            return;
        }
        
        // Preencher o campo hidden com o projectId
        const projectIdField = document.getElementById('newSprintProjectId');
        projectIdField.value = projectId;
        console.log('Set newSprintProjectId to:', projectIdField.value);
        
        // Preencher as datas de validação do projeto
        const projectStartHidden = document.getElementById('projectStartDateHidden-' + projectId);
        const projectEndHidden = document.getElementById('projectEndDateHidden-' + projectId);
        const lastSprintEndHidden = document.getElementById('lastSprintEndHidden-' + projectId);
        
        const projectStart = projectStartHidden ? projectStartHidden.value : null;
        const projectEnd = projectEndHidden ? projectEndHidden.value : null;
        const lastSprintEnd = lastSprintEndHidden ? lastSprintEndHidden.value : null;
        
        if (projectStart) {
            document.getElementById('currentProjectStart').value = projectStart;
        }
        if (projectEnd) {
            document.getElementById('currentProjectEnd').value = projectEnd;
        }
        if (lastSprintEnd) {
            document.getElementById('currentLastSprintEnd').value = lastSprintEnd;
        } else {
            document.getElementById('currentLastSprintEnd').value = '';
        }
        
        // Configurar datas mínimas para os inputs
        setSprintDateConstraints();
        
        // Limpar valores anteriores
        document.getElementById('sprintStartDate').value = '';
        document.getElementById('sprintEndDate').value = '';
        
        // Atualizar label do sprint (ex: SPRINT 2 se já existe 1)
        const sprintsContainer = button.closest('.content-card').querySelector('.sprints-container');
        const sprintCount = sprintsContainer ? sprintsContainer.querySelectorAll('.sprint-item').length : 0;
        document.getElementById('nextSprintLabel').textContent = 'SPRINT ' + (sprintCount + 1);
    }

    function setSprintDateConstraints() {
        const startInput = document.getElementById('sprintStartDate');
        const endInput = document.getElementById('sprintEndDate');
        const projectEnd = document.getElementById('currentProjectEnd').value;
        const lastSprintEnd = document.getElementById('currentLastSprintEnd').value;
        
        if (!startInput || !endInput) return;
        
        // Data mínima de início: amanhã OU dia seguinte ao fim do último sprint (o que for maior)
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        let minStart = formatDateToYMD(tomorrow);
        
        // Se existe um sprint anterior, a data mínima é o dia seguinte ao fim desse sprint
        if (lastSprintEnd) {
            const dayAfterLastSprint = addDaysYMD(lastSprintEnd, 1);
            if (dayAfterLastSprint > minStart) {
                minStart = dayAfterLastSprint;
            }
        }
        
        startInput.min = minStart;
        
        // Data máxima: fim do projeto
        if (projectEnd) {
            startInput.max = projectEnd;
            endInput.max = projectEnd;
        }
        
        // Data mínima de fim: dia seguinte ao início
        if (startInput.value) {
            endInput.min = addDaysYMD(startInput.value, 1);
        } else {
            endInput.min = addDaysYMD(minStart, 1);
        }
    }

    function updateSprintEndDateMin() {
        const startInput = document.getElementById('sprintStartDate');
        const endInput = document.getElementById('sprintEndDate');
        
        if (!startInput || !endInput) return;
        
        // Limpar mensagens de validação
        startInput.setCustomValidity('');
        endInput.setCustomValidity('');
        
        if (startInput.value) {
            endInput.min = addDaysYMD(startInput.value, 1);
        }
    }

    // ==========================================
    // 4. INICIALIZAÇÃO (DOM CONTENT LOADED)
    // ==========================================

    document.addEventListener('DOMContentLoaded', function() {
        
        // Carrega notificações ao abrir a página para atualizar o badge
        fetchNotifications();

        // --- Validação de Datas do Sprint ---
        const sprintStartInput = document.getElementById('sprintStartDate');
        const sprintEndInput = document.getElementById('sprintEndDate');
        const sprintForm = document.getElementById('newSprintForm');

        if (sprintStartInput) {
            sprintStartInput.addEventListener('input', updateSprintEndDateMin);
        }
        if (sprintEndInput) {
            sprintEndInput.addEventListener('input', function() { this.setCustomValidity(''); });
        }

        if (sprintForm) {
            sprintForm.addEventListener('submit', function(event) {
                // Limpar mensagens de validação anteriores
                if (sprintStartInput) sprintStartInput.setCustomValidity('');
                if (sprintEndInput) sprintEndInput.setCustomValidity('');

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const startVal = sprintStartInput ? sprintStartInput.value : '';
                const endVal = sprintEndInput ? sprintEndInput.value : '';
                const projectStart = document.getElementById('currentProjectStart').value;
                const projectEnd = document.getElementById('currentProjectEnd').value;
                const lastSprintEnd = document.getElementById('currentLastSprintEnd').value;
                
                let isValid = true;

                if (startVal) {
                    const sDate = new Date(startVal + 'T00:00:00');
                    
                    // Validação 1: Data de início deve ser posterior a hoje
                    if (sDate.getTime() <= today.getTime()) {
                        sprintStartInput.setCustomValidity('A data de início deve ser posterior à data de hoje.');
                        isValid = false;
                    }
                    
                    // Validação 2: Data de início deve ser posterior ao fim do último sprint
                    if (isValid && lastSprintEnd) {
                        const lastEnd = new Date(lastSprintEnd + 'T00:00:00');
                        if (sDate.getTime() <= lastEnd.getTime()) {
                            sprintStartInput.setCustomValidity('A data de início deve ser posterior ao fim do sprint anterior (' + lastSprintEnd + ').');
                            isValid = false;
                        }
                    }
                    
                    // Validação 3: Data de início deve estar dentro do período do projeto
                    if (isValid && projectStart) {
                        const pStart = new Date(projectStart + 'T00:00:00');
                        if (sDate.getTime() < pStart.getTime()) {
                            sprintStartInput.setCustomValidity('A data de início deve ser igual ou posterior ao início do projeto (' + projectStart + ').');
                            isValid = false;
                        }
                    }
                    
                    if (isValid && projectEnd) {
                        const pEnd = new Date(projectEnd + 'T00:00:00');
                        if (sDate.getTime() > pEnd.getTime()) {
                            sprintStartInput.setCustomValidity('A data de início deve ser anterior ao fim do projeto (' + projectEnd + ').');
                            isValid = false;
                        }
                    }
                }

                if (startVal && endVal) {
                    const sDate = new Date(startVal + 'T00:00:00');
                    const eDate = new Date(endVal + 'T00:00:00');
                    
                    // Validação 4: Data de fim deve ser posterior à data de início
                    if (sDate.getTime() >= eDate.getTime()) {
                        sprintStartInput.setCustomValidity('A data de início deve ser anterior à data de fim.');
                        sprintEndInput.setCustomValidity('A data de fim deve ser posterior à data de início.');
                        isValid = false;
                    }
                    
                    // Validação 5: Data de fim deve estar dentro do período do projeto
                    if (isValid && projectEnd) {
                        const pEnd = new Date(projectEnd + 'T00:00:00');
                        if (eDate.getTime() > pEnd.getTime()) {
                            sprintEndInput.setCustomValidity('A data de fim deve ser igual ou anterior ao fim do projeto (' + projectEnd + ').');
                            isValid = false;
                        }
                    }
                }

                if (!isValid || !sprintForm.checkValidity()) {
                    // Mostrar validação nativa do browser
                    sprintForm.reportValidity();
                    event.preventDefault();
                }
            });
        }

        // --- Configuração de Password ---
        const editProfileForm = document.getElementById('editProfileForm');
        if (editProfileForm) {
            editProfileForm.addEventListener('submit', function(event) {
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                const newPasswordError = document.getElementById('newPasswordError');
                const confirmPasswordError = document.getElementById('confirmNewPasswordError');

                let isValid = true;
                newPasswordError.style.display = 'none';
                confirmPasswordError.style.display = 'none';

                if (newPassword) {
                    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[A-Za-z\d]{8,}$/;
                    if (!passwordRegex.test(newPassword)) {
                        newPasswordError.textContent = 'A password deve ter pelo menos 8 caracteres, incluindo maiúscula, minúscula e número.';
                        newPasswordError.style.display = 'block';
                        isValid = false;
                    }
                }

                if (newPassword && confirmPassword !== newPassword) {
                    confirmPasswordError.textContent = 'As passwords não coincidem.';
                    confirmPasswordError.style.display = 'block';
                    isValid = false;
                }

                if (!isValid) event.preventDefault();
            });
        }

        // --- Configuração de Imagem ---
        const imageInput = document.getElementById('imageUploadStudent');
        const placeholder = document.getElementById('profileImagePlaceholder');
        const existingPreview = document.getElementById('profileImagePreview');
        
        if (existingPreview && existingPreview.src && existingPreview.src.includes('/uploads/')) {
            previewImg = existingPreview;
            hasExistingImage = true;
            existingPreview.style.display = 'block';
            if (placeholder) placeholder.style.display = 'none';
        } else {
            if (existingPreview) existingPreview.style.display = 'none';
            if (placeholder) placeholder.style.display = 'flex';
        }

        if (imageInput) {
            imageInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (!previewImg) {
                            const newImg = document.createElement('img');
                            newImg.id = 'profileImagePreview';
                            newImg.className = 'rounded-circle border-4 border-primary shadow-lg position-absolute';
                            newImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 10; transition: display 0.3s ease;';
                            newImg.src = e.target.result;
                            const container = document.querySelector('[style*="width: 120px"]');
                            if (container) container.appendChild(newImg);
                            previewImg = newImg;
                        } else {
                            previewImg.src = e.target.result;
                        }
                        previewImg.style.display = 'block';
                        if (placeholder) placeholder.style.display = 'none';
                        const removeBtn = document.getElementById('removeImageBtn');
                        if (removeBtn) removeBtn.style.display = 'flex';
                        const removeTip = document.getElementById('removeTip');
                        if (removeTip) removeTip.style.display = 'block';
                        document.getElementById('removeImage').value = 'false';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // --- Configuração de Reset do Modal de Perfil ---
        const editModal = document.getElementById('editStudentProfileModal');
        if (editModal) {
            editModal.addEventListener('hide.bs.modal', function() {
                const form = document.getElementById('editProfileForm');
                if (form) form.reset();
                if (imageInput) imageInput.value = '';
                const removeImageFlag = document.getElementById('removeImage');
                if (removeImageFlag) removeImageFlag.value = 'false';
                location.reload(); 
            });
        }

        // --- Configuração de Tema ---
        const themeSwitcher = document.getElementById('theme-switcher');
        const body = document.body;
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme === 'dark') {
            body.classList.add('dark-theme');
            if(themeSwitcher) themeSwitcher.checked = true;
        }
        if(themeSwitcher) {
            themeSwitcher.addEventListener('change', () => {
                if (themeSwitcher.checked) {
                    body.classList.add('dark-theme');
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.classList.remove('dark-theme');
                    localStorage.setItem('theme', 'light');
                }
            });
        }

        // --- Handler de Inscrição em Curso ---
        const enrollForm = document.getElementById('enrollForm');
        if (enrollForm) {
            enrollForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const formData = new FormData(enrollForm);
                const submitBtn = document.getElementById('enrollSubmitBtn');
                const errorDiv = document.getElementById('enrollErrorMessage');
                const errorText = document.getElementById('enrollErrorText');
                
                if(errorDiv) errorDiv.style.setProperty('display', 'none', 'important');
                
                if(submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>A validar...';
                }
                
                fetch(enrollForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => {
                    if (response.ok) {
                        return response.text().then(courseName => {
                            sessionStorage.setItem('enrollSuccessMessage', 'Inscrição realizada com sucesso! Bem-vindo ao curso ' + courseName + '.');
                            window.location.href = window.location.pathname + '?tab=all-courses&t=' + Date.now();
                        });
                    } else {
                        return response.text().then(text => { throw new Error(text || 'O código de acesso está incorreto.'); });
                    }
                })
                .catch(error => {
                    if(errorDiv && errorText) {
                        errorText.textContent = error.message || 'O código de acesso está incorreto.';
                        errorDiv.style.setProperty('display', 'flex', 'important');
                        lucide.createIcons();
                    }
                    const codeInput = document.getElementById('accessCode');
                    if(codeInput) { codeInput.value = ''; codeInput.focus(); }
                })
                .finally(() => {
                    if(submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Validar e Entrar';
                    }
                });
            });
        }

        // --- Mensagens de Sucesso e Tabs ---
        const enrollSuccessMsg = sessionStorage.getItem('enrollSuccessMessage');
        if (enrollSuccessMsg) {
            sessionStorage.removeItem('enrollSuccessMessage');
            const alertContainer = document.querySelector('.container.mt-3');
            if (alertContainer) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show shadow-sm border-0';
                alertDiv.setAttribute('role', 'alert');
                alertDiv.style.cssText = 'background-color: #d1e7dd; color: #0f5132;';
                alertDiv.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5 inline me-2"></i>' + enrollSuccessMsg + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
                alertContainer.insertBefore(alertDiv, alertContainer.firstChild);
                lucide.createIcons();
                setTimeout(function() { new bootstrap.Alert(alertDiv).close(); }, 3000);
            }
        }

        // --- Mensagens de Sucesso/Erro de Equipas ---
        const teamSuccessMsg = sessionStorage.getItem('teamSuccessMessage');
        if (teamSuccessMsg) {
            sessionStorage.removeItem('teamSuccessMessage');
            const alertContainer = document.querySelector('.container.mt-3');
            if (alertContainer) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show shadow-sm border-0';
                alertDiv.setAttribute('role', 'alert');
                alertDiv.style.cssText = 'background-color: #d1e7dd; color: #0f5132;';
                alertDiv.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5 inline me-2"></i>' + teamSuccessMsg + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
                alertContainer.insertBefore(alertDiv, alertContainer.firstChild);
                lucide.createIcons();
                setTimeout(function() { new bootstrap.Alert(alertDiv).close(); }, 3000);
            }
        }

        const teamErrorMsg = sessionStorage.getItem('teamErrorMessage');
        if (teamErrorMsg) {
            sessionStorage.removeItem('teamErrorMessage');
            const alertContainer = document.querySelector('.container.mt-3');
            if (alertContainer) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show shadow-sm border-0';
                alertDiv.setAttribute('role', 'alert');
                alertDiv.style.cssText = 'background-color: #f8d7da; color: #842029;';
                alertDiv.innerHTML = '<i data-lucide="alert-circle" class="w-5 h-5 inline me-2"></i>' + teamErrorMsg + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
                alertContainer.insertBefore(alertDiv, alertContainer.firstChild);
                lucide.createIcons();
                setTimeout(function() { new bootstrap.Alert(alertDiv).close(); }, 5000);
            }
        }

        const successAlert = document.querySelector('.alert-success');
        if (successAlert) {
            setTimeout(function() { new bootstrap.Alert(successAlert).close(); }, 3000);
        }

        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');
        if (activeTab) {
            const tabBtn = document.querySelector(`.tab-btn[onclick*="'${activeTab}'"]`);
            if (tabBtn) openTab(activeTab, tabBtn);
        }

        // --- Gráfico de Evolução ---
        if(typeof Chart !== 'undefined' && pointHistory && pointHistory.length > 0) {
            const labels = [];
            const dataPoints = [];
            pointHistory.forEach(point => {
                labels.push(new Date(point.date).toLocaleDateString());
                dataPoints.push(point.totalPoints);
            });

            const ctx = document.getElementById('scoreEvolutionChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pontuação Acumulada',
                        data: dataPoints,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Auto-dismiss success alerts after 3 seconds (already declared above, just use it)
        if (successAlert) {
            setTimeout(function() {
                const bsAlert = new bootstrap.Alert(successAlert);
                bsAlert.close();
            }, 3000);
        }
    });
    </script>

    <!-- Modal Detalhes do Curso e Equipa -->
    <div class="modal fade" id="courseDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold" id="courseDetailsTitle">Detalhes do Curso</h4>
                        <p class="text-muted small mb-0">Gerir a tua participação em equipas</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Se o aluno está numa equipa -->
                    <div id="studentTeamDetailsSection" style="display: none;">
                        <h5 class="fw-bold text-primary mb-3">A Tua Equipa</h5>
                        <div id="teamDetailsCard" class="content-card border-start border-4 border-success">
                            <!-- Team details will be populated here -->
                        </div>
                    </div>

                    <!-- Se o aluno NÃO está numa equipa -->
                    <div id="studentNoTeamSection" style="display: none;">
                        <h5 class="fw-bold text-secondary mb-3">Não Estás Numa Equipa</h5>
                        <p class="text-muted mb-4">Podes criar uma nova equipa ou juntar-te a uma equipa existente que tenha vagas disponíveis.</p>
                        
                        <div class="d-flex gap-3">
                            <button class="btn btn-success flex-fill rounded-pill py-2 fw-bold" onclick="setupCreateTeamModal();" data-bs-toggle="modal" data-bs-target="#studentCreateTeamModal">
                                <i data-lucide="plus" style="width: 18px; height: 18px;" class="me-2"></i>Criar Equipa
                            </button>
                            <button class="btn btn-primary flex-fill rounded-pill py-2 fw-bold" onclick="setupJoinTeamModal();" data-bs-toggle="modal" data-bs-target="#studentJoinTeamModal">
                                <i data-lucide="user-plus" style="width: 18px; height: 18px;" class="me-2"></i>Juntar-se a Equipa
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Criar Equipa (Aluno) -->
    <div class="modal fade" id="studentCreateTeamModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold">Criar Nova Equipa</h4>
                        <p class="text-muted small mb-0">Convida os teus colegas para a equipa</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/teams/create}" method="POST" id="studentCreateTeamForm">
                        <input type="hidden" name="courseId" id="studentTeamCourseId">
                        <input type="hidden" name="studentId" th:value="${student.id}">

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Nome da Equipa</label>
                            <input type="text" name="name" class="form-control bg-light border-0" required placeholder="Ex: Team Alpha">
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label small text-muted">Product Owner</label>
                                <select name="productOwnerId" class="form-select bg-light border-0 student-member-select" onchange="updateStudentTeamOptions()">
                                    <option value="">Escolher (opcional)...</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label small text-muted">Scrum Master</label>
                                <select name="scrumMasterId" class="form-select bg-light border-0 student-member-select" onchange="updateStudentTeamOptions()">
                                    <option value="">Escolher (opcional)...</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small text-muted d-flex justify-content-between align-items-center">Developers
                                <button type="button" id="addStudentDeveloperBtn" class="btn btn-link p-0 text-decoration-none small fw-bold" onclick="addStudentDeveloperField()">+ Adicionar outro</button>
                            </label>
                            <div id="student-developers-container">
                                <div class="input-group mb-2 student-developer-row">
                                    <select name="developerIds" class="form-select bg-light border-0 student-member-select" onchange="updateStudentTeamOptions()">
                                        <option value="">Selecionar Developer (opcional)...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer border-0 px-0 pb-0">
                            <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success rounded-pill px-4 fw-bold">Criar Equipa</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Juntar-se a Equipa -->
    <div class="modal fade" id="studentJoinTeamModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold">Juntar-se a uma Equipa</h4>
                        <p class="text-muted small mb-0">Escolhe uma equipa com vagas disponíveis</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="availableTeamsContainer">
                        <!-- Available teams will be loaded here -->
                    </div>
                    <div id="noTeamsMessage" class="alert alert-info" style="display: none;">
                        Não há equipas com vagas disponíveis neste curso.
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>