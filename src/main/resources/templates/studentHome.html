<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>EduScrum - Área do Estudante</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/images/favicon.svg}">
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.0/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/estilo.css}">
    <link rel="stylesheet" th:href="@{/css/dark-theme.css}">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
    /* Cartões de Resumo (Topo) */
    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        border: 1px solid #f0f0f0;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .stat-icon-wrapper {
        width: 40px; 
        height: 40px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        border-radius: 50%;
    }

    /* Tabela de Comparação (Esquerda) */
    .comparison-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        border-radius: 12px;
        margin-bottom: 12px;
        font-weight: 500;
    }
    .comp-user { background-color: #e3f2fd; color: #0d47a1; }
    .comp-avg { background-color: #f8f9fa; color: #495057; }
    .comp-diff { background-color: #e8f5e9; color: #1b5e20; }

    /* Top 5 Estudantes (Direita) */
    .ranking-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 8px;
        font-weight: 500;
    }
    .rank-gold { background-color: #fff9c4; color: #fbc02d; }
    .rank-silver { background-color: #f5f5f5; color: #616161; }
    .rank-bronze { background-color: #fff3e0; color: #ef6c00; }
    .rank-normal { background-color: transparent; color: #495057; }
    
    .rank-me {
        border: 2px solid #90caf9;
        background-color: #e3f2fd;
    }

    .rank-badge {
        width: 28px; 
        height: 28px; 
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        font-size: 0.8rem;
        margin-right: 12px;
        background: white;
        font-weight: bold;
    }

    /* Estilos para a foto de perfil */
    #removeImageBtn:hover,
    label[for="imageUploadStudent"]:hover {
        transform: scale(1.1);
    }

    #removeImageBtn {
        transition: all 0.3s ease;
    }

    label[for="imageUploadStudent"] {
        transition: all 0.3s ease;
    }

    #profileImagePreview,
    #profileImagePlaceholder {
        transition: all 0.3s ease;
    }

    /* Notification Sidebar Styles */
    .notification-sidebar {
        position: fixed;
        top: 0;
        right: -400px; /* Hidden by default */
        width: 400px;
        height: 100%;
        background-color: #f8f9fa; /* Matching the body background */
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 1050;
        transition: right 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
        border-left: 1px solid #e9ecef;
    }

    .notification-sidebar.open {
        right: 0; /* Visible */
    }

    .notification-sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #ffffff; /* White header for better contrast */
    }

    .notification-sidebar-header h5 {
        color: var(--bs-body-color);
        cursor: pointer;
    }

    .notification-sidebar-body {
        flex-grow: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background-color: #f8f9fa;
    }

    .notification-item {
        background-color: transparent;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        transition: all 0.2s ease;
        color: #212529;
    }

    .notification-item:hover {
        background-color: rgba(0, 0, 0, 0.05);
        border-color: rgba(0, 0, 0, 0.2);
    }

    .notification-item.unread {
        background-color: rgba(13, 110, 253, 0.1);
        border-color: rgba(13, 110, 253, 0.2);
    }

    .notification-item.unread:hover {
        background-color: rgba(13, 110, 253, 0.15);
        border-color: rgba(13, 110, 253, 0.3);
    }

    .notification-content h6 {
        color: inherit;
        margin: 0 0 4px 0;
        font-weight: 600;
    }

    .notification-content p {
        color: inherit;
        opacity: 0.9;
        margin: 0 0 8px 0;
    }

    .notification-time {
        font-size: 0.8rem;
        opacity: 0.8;
        color: inherit;
    }

    .notification-icon {
        flex-shrink: 0;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .notification-content {
        flex-grow: 1;
    }

    .notification-content h6 {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--bs-body-color);
    }

    .notification-content p {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .notification-time {
        font-size: 0.75rem;
        color: #adb5bd;
        text-align: right;
        flex-shrink: 0;
    }

    .notification-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .notification-actions .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    </style>
</head>
<body class="student-bg">

    <nav class="navbar-student d-flex justify-content-between align-items-center p-3 sticky-top">
        <div class="d-flex align-items-center gap-3">
            <div class="bg-success text-white p-2 rounded-3 shadow-sm"><i data-lucide="graduation-cap" style="width: 24px; height: 24px;"></i></div>
            <div><h5 class="mb-0 fw-bold" style="color: #2c3e50;">EduScrum</h5><small class="text-muted">Área do Estudante</small></div>
        </div>
        <div class="d-flex align-items-center gap-4">
            <div id="notificationBellContainer" class="position-relative cursor-pointer p-2 rounded-circle hover-bg-light" onclick="toggleNotificationSidebar()">
                <i id="notificationBellIcon" data-lucide="bell" class="text-secondary"></i>
                <span id="notificationCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem; display: none;">0</span>
            </div>
            <div class="vr text-muted opacity-25" style="height: 30px;"></div>
            <div class="dropdown">
                <a href="#" class="profile-trigger text-decoration-none d-flex align-items-center gap-3" data-bs-toggle="dropdown">
                    <div class="text-end d-none d-md-block">
                        <div class="profile-name fw-bold text-dark" th:text="${student.name}">Aluno</div>
                        <div class="profile-email small text-muted" th:text="${student.email}">email@upt.pt</div>
                    </div>
                    <img th:if="${student.profileImage != null}" th:src="@{'/uploads/profile-images/' + ${student.profileImage}}" class="rounded-circle shadow-sm border" style="width: 42px; height: 42px; object-fit: cover;">
                    <div th:unless="${student.profileImage != null}" class="profile-avatar bg-success text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm" style="width: 42px; height: 42px; font-size: 1.2rem;" th:text="${#strings.substring(student.name,0,1)}">A</div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-3 mt-2">
                    <li><a class="dropdown-item py-2" href="#" data-bs-toggle="modal" data-bs-target="#editStudentProfileModal"><i data-lucide="user" class="w-4 h-4 inline me-2 opacity-50"></i> Editar Perfil</a></li>
                    <li>
                        <a class="dropdown-item py-2" href="#" data-bs-toggle="modal" data-bs-target="#settingsModal">
                            <i data-lucide="settings" class="w-4 h-4 inline me-2 opacity-50"></i> Configurações
                        </a>
                    </li>
                    <li><hr class="dropdown-divider my-2"></li>
                    <li><a class="dropdown-item py-2 text-danger" th:href="@{/logout}"><i data-lucide="log-out" class="w-4 h-4 inline me-2 opacity-50"></i> Sair</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Notification Sidebar -->
    <div id="notificationSidebar" class="notification-sidebar">
        <div class="notification-sidebar-header">
            <h5 class="fw-bold mb-0" onclick="toggleNotificationSidebar()">Notificações</h5>
            <button type="button" class="btn-close" aria-label="Close" onclick="toggleNotificationSidebar()"></button>
        </div>
        <div class="notification-sidebar-body">
            <div id="notificationsContainer">
                <!-- Notification items will be loaded here -->
                <div class="text-center text-muted mt-4" id="noNotifications" style="display: none;">
                    <i data-lucide="bell-off" class="w-8 h-8 mb-2"></i>
                    <p>Nenhuma notificação nova.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-3" style="max-width: 1200px;">
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show shadow-sm border-0" role="alert" style="background-color: #d1e7dd; color: #0f5132;">
            <i data-lucide="check-circle" class="w-5 h-5 inline me-2"></i><span th:text="${successMessage}">Sucesso!</span><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show shadow-sm border-0" role="alert" style="background-color: #f8d7da; color: #842029;">
            <i data-lucide="alert-circle" class="w-5 h-5 inline me-2"></i><span th:text="${errorMessage}">Erro!</span><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <div class="tabs-container shadow-sm">
        <button class="tab-btn active" onclick="openTab('overview', this)"><i data-lucide="layout-dashboard" class="inline-block w-4 h-4 me-2"></i>Visão Geral</button>
        <button class="tab-btn" onclick="openTab('all-courses', this)"><i data-lucide="book-open" class="inline-block w-4 h-4 me-2"></i>Cursos</button>
        <button class="tab-btn" onclick="openTab('my-awards', this)"><i data-lucide="award" class="inline-block w-4 h-4 me-2"></i>Meus Prémios</button>
        <button class="tab-btn" onclick="openTab('projects', this)"><i data-lucide="folder-kanban" class="inline-block w-4 h-4 me-2"></i>Projetos</button>
    </div>

    <div class="container pb-5" style="max-width: 1200px;">

        <div id="overview" class="tab-content active">
            
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="text-muted small fw-bold">Pontuação Total</span>
                            <i data-lucide="trophy" class="text-warning" style="width: 20px;"></i>
                        </div>
                        <h2 class="fw-bold mb-1 text-dark" style="font-size: 2.5rem;" th:text="${student.totalPoints}">850</h2>
                        <small class="text-muted">+5% vs média</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="text-muted small fw-bold">Ranking</span>
                            <i data-lucide="trending-up" class="text-primary" style="width: 20px;"></i>
                        </div>
                        <h2 class="fw-bold mb-1 text-dark" style="font-size: 2.5rem;" th:text="'#' + ${student.currentRank}">#5</h2>
                        <small class="text-muted">de 30 estudantes</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="text-muted small fw-bold">Prémios Ganhos</span>
                            <i data-lucide="medal" class="text-purple-500" style="color: #a855f7; width: 20px;"></i>
                        </div>
                        <h2 class="fw-bold mb-1 text-dark" style="font-size: 2.5rem;" th:text="${student.earnedAwards != null ? #lists.size(student.earnedAwards) : 0}">1</h2>
                        <small class="text-muted">pontos acumulados</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="text-muted small fw-bold">Equipas Ativas</span>
                            <i data-lucide="users" class="text-success" style="width: 20px;"></i>
                        </div>
                        <h2 class="fw-bold mb-1 text-dark" style="font-size: 2.5rem;" th:text="${student.projects != null ? #lists.size(student.projects) : 0}">2</h2>
                        <small class="text-muted">projetos</small>
                    </div>
                </div>
            </div>

            <div class="stat-card mb-4" style="height: auto;">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <i data-lucide="line-chart" class="text-dark" style="width: 18px;"></i>
                    <h6 class="fw-bold mb-0">Evolução de Pontuação</h6>
                </div>
                <p class="text-muted small mb-4">Progressão acumulada dos seus pontos ao longo do tempo</p>
                
                <div style="height: 300px; width: 100%;">
                    <canvas id="scoreEvolutionChart"></canvas>
                </div>
            </div>

            <div class="row g-4 mb-5">
                
                <div class="col-md-6">
                    <div class="stat-card">
                        <div class="d-flex align-items-center gap-2 mb-4">
                            <i data-lucide="bar-chart-2" class="text-dark" style="width: 18px;"></i>
                            <h6 class="fw-bold mb-0">Comparação com a Turma</h6>
                        </div>
                        <p class="text-muted small mt-n3 mb-4">Seu desempenho vs média</p>

                        <div class="comparison-row comp-user">
                            <span>Sua Pontuação</span>
                            <span class="fw-bold" th:text="${student.totalPoints} + ' pts'">850 pts</span>
                        </div>

                        <div class="comparison-row comp-avg">
                            <span>Média da Turma</span>
                            <span class="fw-bold" th:text="${#numbers.formatDecimal(student.classAverage, 1, 0)} + ' pts'">810 pts</span>
                        </div>

                        <div class="comparison-row comp-diff">
                            <span>Diferença</span>
                            <span class="fw-bold" th:text="'+' + ${#numbers.formatDecimal(student.totalPoints - student.classAverage, 1, 0)} + ' pts'">+40 pts</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-3 pt-3">
                            <span class="text-muted small">Percentil</span>
                            <span class="badge bg-primary px-3 py-2 rounded-pill">Top 20%</span>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="stat-card">
                        <div class="d-flex align-items-center gap-2 mb-4">
                            <i data-lucide="trophy" class="text-warning" style="width: 18px;"></i>
                            <h6 class="fw-bold mb-0">Top 5 Estudantes</h6>
                        </div>
                        <p class="text-muted small mt-n3 mb-4">Melhores classificações da turma</p>

                        <div class="d-flex flex-column gap-2">
                            <div th:each="topStudent, iter : ${student.topStudents}" 
                                 class="ranking-item"
                                 th:classappend="${iter.index == 0 ? 'rank-gold' : (iter.index == 1 ? 'rank-silver' : (iter.index == 2 ? 'rank-bronze' : 'rank-normal'))}">
                                
                                <div class="d-flex align-items-center">
                                    <div class="rank-badge" th:text="${iter.index + 1}">1</div>
                                    <span th:text="${topStudent.name}">Ana</span>
                                    <i th:if="${iter.index == 0}" data-lucide="crown" class="w-4 h-4 ms-2 text-warning-dark" style="fill: #fbc02d; stroke: none;"></i>
                                </div>
                                <span class="fw-bold" th:text="${topStudent.totalPoints} + ' pts'">920 pts</span>
                            </div>

                            <div class="ranking-item rank-me mt-2">
                                <div class="d-flex align-items-center">
                                    <div class="rank-badge text-primary" th:text="${student.currentRank}">5</div>
                                    <span>Você</span>
                                </div>
                                <span class="fw-bold text-primary" th:text="${student.totalPoints} + ' pts'">850 pts</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <h5 class="fw-bold mb-3">Prémios Recentes</h5>
                <div class="row g-3">
                    <div class="col-md-4" th:each="award, iter : ${student.earnedAwards}" th:if="${iter.index < 3}"> <div class="d-flex align-items-center gap-3 p-3 border rounded-3 bg-light bg-opacity-25">
                            <div class="bg-white p-2 rounded shadow-sm">
                                <i data-lucide="award" class="w-6 h-6 text-warning"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-0 text-dark" th:text="${award.name}">Nome</h6>
                                <small class="text-muted" th:text="${award.description}">Desc</small>
                            </div>
                            <div class="ms-auto fw-bold text-primary" th:text="'+' + ${award.points}">+0</div>
                        </div>
                    </div>
                    <div th:if="${#lists.isEmpty(student.earnedAwards)}" class="col-12 text-center text-muted py-2">Sem prémios recentes.</div>
                </div>
            </div>
        </div>

        <div id="all-courses" class="tab-content">
            <div class="d-flex justify-content-between align-items-center mb-4"><div><h3 class="fw-bold mb-1 text-primary">Meus Cursos</h3><p class="text-muted">Cursos em que estás atualmente inscrito.</p></div></div>
            <div class="row g-3">
                <div class="col-md-6" th:each="course : ${student.enrolledCourses}">
                    <div class="content-card h-100 border-start border-4 border-primary">
                        <div class="d-flex justify-content-between align-items-start"><div><h5 class="fw-bold text-dark mb-1" th:text="${course.name}">Nome</h5><span class="badge bg-primary bg-opacity-10 text-primary rounded-pill mb-2" th:text="${course.code}">CODE</span><p class="text-muted small mb-0" th:text="${course.description}">Desc</p></div><i data-lucide="check-circle" class="text-primary" style="width: 24px; height: 24px;"></i></div>
                        <div class="mt-3 pt-3 border-top d-flex justify-content-between align-items-center"><small class="text-muted fw-bold">Inscrito</small><button class="btn btn-sm btn-outline-primary rounded-pill px-3">Ver Detalhes</button></div>
                    </div>
                </div>
                <div th:if="${#lists.isEmpty(student.enrolledCourses)}" class="col-12 text-center py-4 bg-white rounded-3 border border-dashed"><p class="text-muted mb-0">Não estás inscrito em nenhum curso.</p></div>
            </div>
            <hr class="my-5 opacity-25">
            <div class="d-flex justify-content-between align-items-center mb-4"><div><h4 class="fw-bold mb-1 text-secondary">Outros Cursos Disponíveis</h4></div></div>
            <div class="row g-3">
                <div class="col-md-4" th:each="course : ${student.availableCourses}">
                    <div class="content-card h-100 bg-light bg-opacity-50">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="fw-bold text-dark mb-0" th:text="${course.name}">Nome</h6>
                            <span class="badge bg-secondary bg-opacity-10 text-secondary" th:text="${course.code}">CODE</span>
                        </div>
                        <p class="text-muted small mb-3" th:text="${#strings.abbreviate(course.description, 50)}">Desc</p>
                    <button class="btn btn-sm btn-outline-primary rounded-pill w-100 shadow-sm fw-bold transition hover-scale"
                            data-bs-toggle="modal" 
                            data-bs-target="#enrollModal"
                            th:data-id="${course.id}"
                            th:data-name="${course.name}"
                            onclick="setupEnrollModal(this)">
                        Inscrever-se
                    </button>
                </div>
            </div>
        </div>
    </div>
        <div id="my-awards" class="tab-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="fw-bold mb-1">Todos os Prémios</h3>
                    <p class="text-muted">Histórico completo dos seus prémios</p>
                </div>
                <div class="bg-white px-4 py-2 rounded-pill shadow-sm border d-flex align-items-center gap-2">
                    <span class="text-muted small fw-bold text-uppercase">Total</span>
                    <span class="fw-bold text-primary" style="font-size: 1.2rem;" th:text="${student.totalPoints} + ' pts'">0 pts</span>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6" th:each="award : ${student.earnedAwards}">
                    <div class="content-card h-100 p-4 border hover-shadow transition" 
                         style="border-left: 5px solid #ffc107 !important;"> <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex gap-3">
                                <div class="rounded-3 d-flex align-items-center justify-content-center" 
                                     style="width: 50px; height: 50px; background-color: #fff9c4;">
                                    <i data-lucide="trophy" class="text-warning" style="width: 24px; height: 24px;"></i>
                                </div>
                                <div>
                                    <h5 class="fw-bold text-dark mb-1" th:text="${award.name}">Innovation Hero</h5>
                                    <p class="text-muted small mb-0" th:text="${award.description}">Implementação de features inovadoras</p>
                                </div>
                            </div>
                            <span class="badge bg-light text-dark border fw-bold" th:text="${award.type}">Manual</span>
                        </div>

                        <div class="d-flex align-items-center justify-content-between mt-3 pt-3 border-top border-light">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-warning bg-opacity-25 text-warning-dark fw-bold px-3 py-1 rounded-pill" 
                                      style="color: #b45309;" 
                                      th:text="'+' + ${award.points} + ' pontos'">+150 pontos</span>
                            </div>
                            <small class="text-muted fst-italic">Atribuído recentemente</small>
                        </div>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(student.earnedAwards)}" class="col-12">
                    <div class="text-center py-5 content-card bg-light border-dashed">
                        <div class="mb-3 p-3 bg-white rounded-circle d-inline-block shadow-sm">
                            <i data-lucide="award" class="w-8 h-8 text-muted opacity-50"></i>
                        </div>
                        <h6 class="fw-bold text-muted">Ainda não tens prémios.</h6>
                        <p class="text-muted small mb-0">Continua o bom trabalho para desbloquear conquistas!</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="projects" class="tab-content">
            
            <div th:if="${student.projects != null}" th:each="project : ${student.projects}" class="content-card mb-4 border-0 shadow-sm">
                
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div class="d-flex gap-3">
                        <div class="mt-1">
                            <div class="bg-primary rounded-circle" style="width: 12px; height: 12px;"></div>
                        </div>
                        <div>
                            <h4 class="fw-bold text-dark mb-1" th:text="${project.name}">Sistema de Gestão Académica</h4>
                            <p class="text-muted mb-2 small" th:text="${project.sprintGoals}">Plataforma para gestão de estudantes e cursos</p>
                            
                            <div class="d-flex gap-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10" th:text="${student.courseName}">Qualidade de Software</span>
                                <span class="badge bg-purple-100 text-purple-700 border border-purple-200" style="background-color: #f3e8ff; color: #7e22ce;" th:text="${student.roleInTeam}">Scrum Master</span>
                            </div>
                        </div>
                    </div>
                    <span class="badge bg-primary text-white px-3 py-2 rounded-pill">Ativo</span>
                </div>

                <div class="mb-4">
                    <h6 class="text-muted small fw-bold text-uppercase mb-2"><i data-lucide="users" class="w-3 h-3 inline me-1"></i> Equipa <span th:text="${student.teamName}">Alpha</span></h6>
                    <div class="d-flex align-items-center gap-2">
                        <div class="d-flex -space-x-2">
                            <div class="bg-light border rounded-circle d-flex align-items-center justify-content-center text-xs fw-bold text-muted" 
                                 style="width: 32px; height: 32px; font-size: 0.75rem;" title="Você">EU</div>
                            <div class="bg-primary text-white border border-white rounded-circle d-flex align-items-center justify-content-center text-xs fw-bold" 
                                 style="width: 32px; height: 32px; font-size: 0.75rem; margin-left: -8px;">JD</div>
                            <div class="bg-info text-white border border-white rounded-circle d-flex align-items-center justify-content-center text-xs fw-bold" 
                                 style="width: 32px; height: 32px; font-size: 0.75rem; margin-left: -8px;">AS</div>
                        </div>
                        <span class="text-muted small ms-2">Membros ativos</span>
                    </div>
                </div>

                <div class="mb-5">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted small fw-bold">Progresso Geral</span>
                        <span class="text-primary small fw-bold">88%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-primary rounded-pill" role="progressbar" style="width: 88%"></div>
                    </div>
                </div>

                <div>
                    <h6 class="fw-bold mb-3 d-flex align-items-center">
                        <i data-lucide="layers" class="w-4 h-4 me-2 text-dark"></i> Sprints (<span th:text="${project.sprints != null ? #lists.size(project.sprints) : 0}">0</span>)
                    </h6>
                    
                    <div class="d-flex flex-column gap-3">
                        <div th:each="sprint : ${project.sprints}" class="d-flex align-items-center justify-content-between p-3 bg-light rounded-3 border-start border-4"
                             th:classappend="${sprint.status?.name() == 'DONE'} ? 'border-success' : 'border-primary'">
                            
                            <div class="d-flex align-items-center gap-3">
                                <i th:if="${sprint.status?.name() == 'DONE'}" data-lucide="check-circle-2" class="text-success w-5 h-5"></i>
                                <i th:if="${sprint.status?.name() != 'DONE'}" data-lucide="circle-dashed" class="text-primary w-5 h-5"></i>
                                
                                <div>
                                    <h6 class="mb-0 fw-bold text-dark" th:text="${sprint.name}">Sprint 1</h6>
                                    <small class="text-muted" th:text="${sprint.startDate} + ' - ' + ${sprint.endDate}">Datas</small>
                                </div>
                            </div>

                            <div class="d-flex align-items-center gap-3" style="width: 30%;">
                                <div class="progress flex-grow-1" style="height: 6px;">
                                    <div class="progress-bar rounded-pill" 
                                         th:classappend="${sprint.status?.name() == 'DONE'} ? 'bg-success' : 'bg-primary'"
                                         role="progressbar" 
                                         th:style="'width: ' + (${sprint.status?.name() == 'DONE'} ? '100%' : '60%')"></div>
                                </div>
                                <span class="small fw-bold" 
                                      th:classappend="${sprint.status?.name() == 'DONE'} ? 'text-success' : 'text-primary'"
                                      th:text="${sprint.status?.name() == 'DONE'} ? '100%' : 'Active'">100%</span>
                            </div>
                        </div>
                        
                        <div th:if="${#lists.isEmpty(project.sprints)}" class="text-muted small text-center">
                            Nenhuma sprint criada neste projeto.
                        </div>
                    </div>
                </div>
            </div>

            <div th:if="${student.projectId == null || #lists.isEmpty(student.projects)}" class="alert alert-info content-card border-info border-opacity-25 bg-info bg-opacity-10 text-info fw-bold d-flex align-items-center gap-3 p-4">
                <div class="bg-white p-2 rounded-circle shadow-sm">
                    <i data-lucide="info" class="w-6 h-6 text-info"></i>
                </div>
                <div>
                    <h6 class="mb-1 text-dark">Sem Projetos Ativos</h6>
                    <p class="mb-0 fw-normal small text-muted">Atualmente não estás associado a nenhum projeto. Fala com o teu professor para te juntares a uma equipa.</p>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="editStudentProfileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold">Editar Perfil</h4>
                        <p class="text-muted small mb-0">Atualiza os teus dados e foto.</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm" th:action="@{/api/student/profile/update}" method="POST" enctype="multipart/form-data">
                        
                        <input type="hidden" name="id" th:value="${student.id}" /> 
                        
                        <div class="mb-4 text-center">
                            <div class="position-relative d-inline-block" style="width: fit-content;">
                                <!-- Preview da Imagem -->
                                <div class="position-relative" style="width: 120px; height: 120px; margin: 0 auto;">
                                    <img id="profileImagePreview" 
                                         th:src="@{${student.profileImage != null} ? '/uploads/profile-images/' + ${student.profileImage} : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22%3E%3C/svg%3E'}"
                                         class="rounded-circle border-4 border-primary shadow-lg position-absolute" 
                                         th:style="${student.profileImage != null} ? 'width: 100%; height: 100%; object-fit: cover; display: block; transition: display 0.3s ease; top: 0; left: 0; z-index: 10;' : 'width: 100%; height: 100%; object-fit: cover; display: none; transition: display 0.3s ease; top: 0; left: 0; z-index: 10;'"
                                         style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; transition: display 0.3s ease; z-index: 10;">
                                    
                                    <div id="profileImagePlaceholder"
                                         th:style="${student.profileImage != null} ? 'width: 100%; height: 100%; background: linear-gradient(135deg, #f0f7ff 0%, #e0e7ff 100%); display: none; position: absolute; top: 0; left: 0; z-index: 1;' : 'width: 100%; height: 100%; background: linear-gradient(135deg, #f0f7ff 0%, #e0e7ff 100%); display: flex; position: absolute; top: 0; left: 0; z-index: 1;'"
                                         class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-circle border-4 border-primary d-flex justify-content-center align-items-center" 
                                         style="transition: display 0.3s ease;">
                                        <i data-lucide="user" class="w-12 h-12 text-primary opacity-30"></i>
                                    </div>

                                    <!-- Botão Câmara (Editar) -->
                                    <label for="imageUploadStudent" class="position-absolute bottom-0 end-0 bg-success text-white rounded-circle shadow-lg cursor-pointer transition" 
                                           style="width: 42px; height: 42px; display: flex; justify-content: center; align-items: center; transform: translate(6px, 6px); border: 3px solid white; z-index: 20;"
                                           title="Clique para alterar foto">
                                        <i data-lucide="camera" class="w-5 h-5"></i>
                                        <input type="file" id="imageUploadStudent" name="imageFile" accept="image/*" class="d-none">
                                    </label>

                                    <!-- Botão Remover (X) -->
                                    <button type="button" id="removeImageBtn"
                                            class="position-absolute top-0 end-0 bg-danger text-white rounded-circle shadow-lg cursor-pointer transition" 
                                            th:style="${student.profileImage != null} ? 'width: 42px; height: 42px; display: flex; justify-content: center; align-items: center; transform: translate(6px, -6px); border: 3px solid white; padding: 0; transition: display 0.3s ease; z-index: 20;' : 'width: 42px; height: 42px; display: none; justify-content: center; align-items: center; transform: translate(6px, -6px); border: 3px solid white; padding: 0; transition: display 0.3s ease; z-index: 20;'"
                                            title="Clique para remover foto"
                                            onclick="removeProfileImage(event)">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-4 p-3 bg-blue-50 rounded-3 border border-blue-200" style="background-color: #f0f7ff; border-color: #dbeafe;">
                                <p class="text-muted small mb-1"><strong>Clique na câmara para alterar a foto</strong></p>
                            </div>
                            
                       <div class="row g-3 mb-3">
                            <div class="col-sm-5 col-md-4">
                                <label class="form-label fw-bold small text-muted">Tag (ID)</label>
                                <input type="text" class="form-control border-0 py-2 fw-bold text-muted shadow-none"
                                    th:value="${student.studentTag}" readonly disabled
                                    style="cursor: not-allowed">
                            </div>

                            <div class="col-sm-7 col-md-8">
                                <label class="form-label fw-bold small">Nome Completo</label>
                                <input type="text" name="name" class="form-control bg-light border-0 py-2" th:value="${student.name}" required>
                            </div>
                        </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Email</label>
                            <input type="email" name="email" class="form-control bg-light border-0 py-2" th:value="${student.email}" required>
                        </div>
                        
                        <hr class="my-4 text-muted opacity-25">
                        <h6 class="fw-bold small mb-3">Segurança (opcional)</h6>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Password Atual</label>
                            <input type="password" id="currentPassword" name="currentPassword" class="form-control bg-light border-0 py-2" placeholder="Insira a password atual">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Nova Password</label>
                            <input type="password" id="newPassword" name="newPassword" class="form-control bg-light border-0 py-2" placeholder="Deixa em branco para manter a atual">
                            <div id="newPasswordError" class="text-danger small mt-1" style="display: none;"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Confirmar nova password</label>
                            <input type="password" id="confirmNewPassword" name="confirmNewPassword" class="form-control bg-light border-0 py-2" placeholder="Confirme a nova password">
                            <p id="confirmNewPasswordError" class="text-danger small mt-1" style="display: none;"></p>
                        </div>
                        
                        <div class="modal-footer border-0 pt-4 px-0 pb-0">
                            <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success rounded-pill px-4 fw-bold">Guardar Alterações</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold">Configurações</h4>
                        <p class="text-muted small mb-0">Personalize a sua experiência.</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/api/student/settings}" method="POST">
                        <input type="hidden" name="id" th:value="${student.id}">
                        
                        <div class="p-3 bg-light rounded-3 mb-3 border">
                            <h6 class="fw-bold small mb-3 text-dark">Aparência</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input cursor-pointer" type="checkbox" id="theme-switcher">
                                <label class="form-check-label cursor-pointer" for="theme-switcher">Modo Noturno</label>
                            </div>
                        </div>

                        <div class="p-3 bg-light rounded-3 mb-4 border">
                            <h6 class="fw-bold small mb-3 text-dark">Notificações</h6>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input cursor-pointer" type="checkbox" id="notifAwards" name="notificationAwards" 
                                       th:checked="${student.notificationAwards}">
                                <label class="form-check-label cursor-pointer" for="notifAwards">Prémios atribuídos</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input cursor-pointer" type="checkbox" id="notifRankings" name="notificationRankings" 
                                       th:checked="${student.notificationRankings}">
                                <label class="form-check-label cursor-pointer" for="notifRankings">Alterações no Ranking</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Nome de Exibição</label>
                            <input type="text" name="name" class="form-control bg-light border-0 py-2" th:value="${student.name}" required>
                        </div>

                        <div class="modal-footer border-0 pt-0 px-0">
                            <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">Guardar Preferências</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="enrollModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg" style="padding: 20px;">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h4 class="modal-title fw-bold text-primary">Confirmar Inscrição</h4>
                        <p class="text-muted small mb-0">Tens a certeza que queres entrar neste curso?</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/api/student/enroll}" method="POST">
                        <input type="hidden" name="studentId" th:value="${student.id}" />
                        <input type="hidden" id="enrollCourseId" name="courseId" />
                        
                        <div class="alert alert-primary bg-primary bg-opacity-10 border-0 d-flex align-items-center">
                            <i data-lucide="book-open" class="text-primary me-3"></i>
                            <div>
                                <span class="d-block small text-muted text-uppercase fw-bold">Curso</span>
                                <span id="enrollCourseName" class="fw-bold h5 text-dark mb-0">Nome do Curso</span>
                            </div>
                        </div>

                        <p class="small text-muted mb-0">Ao inscreveres-te, terás acesso aos projetos e poderás ser adicionado a equipas.</p>

                        <div class="modal-footer border-0 pt-4 px-0 pb-0">
                            <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">Sim, Inscrever-me</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/webjars/bootstrap/5.3.0/js/bootstrap.bundle.min.js}"></script>
    <script>
        let previewImg = null;
        let hasExistingImage = false;

        // Password validation for edit profile form
        document.addEventListener('DOMContentLoaded', function() {
            const editProfileForm = document.getElementById('editProfileForm');
            if (editProfileForm) {
                editProfileForm.addEventListener('submit', function(event) {
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmNewPassword').value;
                    const newPasswordError = document.getElementById('newPasswordError');
                    const confirmPasswordError = document.getElementById('confirmNewPasswordError');

                    let isValid = true;

                    // Reset errors
                    newPasswordError.style.display = 'none';
                    confirmPasswordError.style.display = 'none';

                    // Validate new password if provided
                    if (newPassword) {
                        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[A-Za-z\d]{8,}$/;
                        if (!passwordRegex.test(newPassword)) {
                            newPasswordError.textContent = 'A password deve ter pelo menos 8 caracteres, incluindo maiúscula, minúscula e número.';
                            newPasswordError.style.display = 'block';
                            isValid = false;
                        }
                    }

                    // Validate confirm password if new password is provided
                    if (newPassword && confirmPassword !== newPassword) {
                        confirmPasswordError.textContent = 'As passwords não coincidem.';
                        confirmPasswordError.style.display = 'block';
                        isValid = false;
                    }

                    if (!isValid) {
                        event.preventDefault();
                    }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('imageUploadStudent');
            const placeholder = document.getElementById('profileImagePlaceholder');
            const existingPreview = document.getElementById('profileImagePreview');
            
            if (existingPreview && existingPreview.src && existingPreview.src.includes('/uploads/')) {
                previewImg = existingPreview;
                hasExistingImage = true;
                existingPreview.style.display = 'block';
                if (placeholder) {
                    placeholder.style.display = 'none';
                }
            } else {
                if (existingPreview) {
                    existingPreview.style.display = 'none';
                }
                if (placeholder) {
                    placeholder.style.display = 'flex';
                }
            }

            if (imageInput) {
                imageInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    
                    if (file) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            if (!previewImg) {
                                const newImg = document.createElement('img');
                                newImg.id = 'profileImagePreview';
                                newImg.className = 'rounded-circle border-4 border-primary shadow-lg position-absolute';
                                newImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 10; transition: display 0.3s ease;';
                                newImg.src = e.target.result;
                                
                                const container = document.querySelector('[style*="width: 120px"]');
                                if (container) {
                                    container.appendChild(newImg);
                                }
                                previewImg = newImg;
                            } else {
                                previewImg.src = e.target.result;
                            }
                            
                            previewImg.style.display = 'block';
                            if (placeholder) {
                                placeholder.style.display = 'none';
                            }
                            
                            const removeBtn = document.getElementById('removeImageBtn');
                            if (removeBtn) {
                                removeBtn.style.display = 'flex';
                            }
                            
                            const removeTip = document.getElementById('removeTip');
                            if (removeTip) {
                                removeTip.style.display = 'block';
                            }
                            
                            document.getElementById('removeImage').value = 'false';
                        };
                        
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        function removeProfileImage(event) {
            event.preventDefault();
            
            document.getElementById('removeImage').value = 'true';
            
            const placeholder = document.getElementById('profileImagePlaceholder');
            const removeBtn = document.getElementById('removeImageBtn');
            
            if (previewImg) {
                previewImg.style.display = 'none';
            }
            
            if (placeholder) {
                placeholder.style.display = 'flex';
            }
            
            if (removeBtn) {
                removeBtn.style.display = 'none';
            }
            
            const removeTip = document.getElementById('removeTip');
            if (removeTip) {
                removeTip.style.display = 'none';
            }
            
            const imageInput = document.getElementById('imageUploadStudent');
            if (imageInput) {
                imageInput.value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const editModal = document.getElementById('editStudentProfileModal');
            if (editModal) {
                editModal.addEventListener('hide.bs.modal', function() {
                    const form = document.getElementById('editProfileForm');
                    if (form) {
                        form.reset();
                    }
                    
                    const imageInput = document.getElementById('imageUploadStudent');
                    if (imageInput) {
                        imageInput.value = '';
                    }
                    
                    const removeImageFlag = document.getElementById('removeImage');
                    if (removeImageFlag) {
                        removeImageFlag.value = 'false';
                    }

                    location.reload();
                });
            }

            const themeSwitcher = document.getElementById('theme-switcher');
            const body = document.body;
            
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'dark') {
                body.classList.add('dark-theme');
                if(themeSwitcher) themeSwitcher.checked = true;
            }

            if(themeSwitcher) {
                themeSwitcher.addEventListener('change', () => {
                    if (themeSwitcher.checked) {
                        body.classList.add('dark-theme');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        body.classList.remove('dark-theme');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }

            // Auto-dismiss success alerts after 3 seconds
            const successAlert = document.querySelector('.alert-success');
            if (successAlert) {
                setTimeout(function() {
                    const bsAlert = new bootstrap.Alert(successAlert);
                    bsAlert.close();
                }, 3000);
            }

            fetchNotifications();
        });

        function toggleNotificationSidebar() {
            const sidebar = document.getElementById('notificationSidebar');
            sidebar.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                fetchNotifications();
            }
        }

        async function fetchNotifications() {
            const notificationsContainer = document.getElementById('notificationsContainer');
            const notificationCountBadge = document.getElementById('notificationCount');
            const notificationBellIcon = document.getElementById('notificationBellIcon');
            const noNotificationsMessage = document.getElementById('noNotifications');

            notificationsContainer.innerHTML = '<div class="text-center text-muted mt-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">A carregar notificações...</p></div>';
            notificationCountBadge.style.display = 'none';
            notificationBellIcon.classList.remove('text-danger');
            notificationBellIcon.classList.add('text-secondary');

            try {
                let notifications = [];
                try {
                    const response = await fetch('/api/notifications/student');
                    if (response.ok) {
                        notifications = await response.json();
                    } else {
                        throw new Error('API returned ' + response.status);
                    }
                } catch (apiError) {
                    console.log('Using mock data due to API error:', apiError);
                    notifications = [
                        { id: 1, title: "Bem-vindo ao EduScrum!", message: "O seu registo foi concluído com sucesso.", type: "WELCOME", timestamp: new Date(Date.now() - 172800000).toISOString(), read: true },
                        { id: 2, title: "Novo projeto atribuído", message: "Foi adicionado ao projeto 'Sistema de Gestão Escolar'.", type: "PROJECT_ASSIGNED", link: "/projects/1", timestamp: new Date(Date.now() - 86400000).toISOString(), read: true },
                        { id: 3, title: "Prémio Desbloqueado!", message: "Parabéns! Ganhou o prémio 'Participação Ativa'.", type: "AWARD", timestamp: new Date().toISOString(), read: false }
                    ];
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                notificationsContainer.innerHTML = '';

                if (notifications.length === 0) {
                    noNotificationsMessage.style.display = 'block';
                    notificationsContainer.appendChild(noNotificationsMessage);
                } else {
                    noNotificationsMessage.style.display = 'none';
                    notifications.forEach(notification => {
                        const notificationElement = createNotificationElement(notification);
                        notificationsContainer.appendChild(notificationElement);
                    });
                }

                const unreadCount = notifications.filter(n => !n.read).length;
                if (unreadCount > 0) {
                    notificationCountBadge.textContent = unreadCount;
                    notificationCountBadge.style.display = 'block';
                    notificationBellIcon.classList.remove('text-secondary');
                    notificationBellIcon.classList.add('text-danger');
                } else {
                    notificationCountBadge.style.display = 'none';
                    notificationBellIcon.classList.remove('text-danger');
                    notificationBellIcon.classList.add('text-secondary');
                }

                lucide.createIcons();

            } catch (error) {
                console.error('Error loading notifications:', error);
                notificationsContainer.innerHTML = `
                    <div class="text-center text-danger mt-4">
                        <i data-lucide="alert-triangle" class="w-8 h-8 mb-2"></i>
                        <p class="mt-2">Erro ao carregar notificações.</p>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="fetchNotifications()">
                            Tentar novamente
                        </button>
                    </div>`;
                lucide.createIcons();
                notificationCountBadge.style.display = 'none';
                notificationBellIcon.classList.remove('text-danger');
                notificationBellIcon.classList.add('text-secondary');
            }
        }

        function createNotificationElement(notification) {
            const item = document.createElement('div');
            item.classList.add('notification-item');
            if (!notification.read) {
                item.classList.add('unread');
            }

            let iconHtml = '';
            let iconBgClass = 'bg-primary';
            switch (notification.type) {
                case 'AWARD':
                    iconHtml = '<i data-lucide="award" class="w-5 h-5"></i>';
                    iconBgClass = 'bg-primary';
                    break;
                case 'TEAM_CREATED':
                    iconHtml = '<i data-lucide="users" class="w-5 h-5"></i>';
                    iconBgClass = 'bg-warning';
                    break;
                case 'PROJECT_COMPLETED':
                    iconHtml = '<i data-lucide="check-circle" class="w-5 h-5"></i>';
                    iconBgClass = 'bg-success';
                    break;
                case 'REMINDER':
                    iconHtml = '<i data-lucide="info" class="w-5 h-5"></i>';
                    iconBgClass = 'bg-info';
                    break;
                default:
                    iconHtml = '<i data-lucide="bell" class="w-5 h-5"></i>';
                    iconBgClass = 'bg-secondary';
            }

            item.innerHTML = `
                <div class="notification-icon ${iconBgClass}">${iconHtml}</div>
                <div class="notification-content">
                    <h6>${notification.title}</h6>
                    <p>${notification.message}</p>
                    <div class="notification-actions">
                        ${notification.link ? `<button class="btn btn-sm btn-outline-primary" onclick="window.location.href='${notification.link}'">Ver Detalhes</button>` : ''}
                        ${!notification.read ? `<button class="btn btn-sm btn-outline-secondary" onclick="markNotificationAsRead('${notification.id}')">Marcar como lida</button>` : ''}
                    </div>
                </div>
                <span class="notification-time">${timeAgo(notification.timestamp)}</span>
            `;
            return item;
        }

        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                fetchNotifications();
            } catch (error) {
                console.error('Erro ao marcar notificação como lida:', error);
            }
        }

        function timeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const seconds = Math.floor((now - date) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " anos atrás";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " meses atrás";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " dias atrás";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " horas atrás";
            return Math.floor(seconds / 60) + " minutos atrás";
        }
    </script>
    <script th:inline="javascript">
        // Configura o modal de inscrição com os dados do curso clicado
        function setupEnrollModal(button) {
            const courseId = button.getAttribute('data-id');
            const courseName = button.getAttribute('data-name');
            
            document.getElementById('enrollCourseId').value = courseId;
            document.getElementById('enrollCourseName').textContent = courseName;
        }

        lucide.createIcons();
        function openTab(tabId, btnElement) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btnElement.classList.add('active');
        }

        // GRÁFICO (Chart.js)
        /*<![CDATA[*/
        const pointHistory = /*[[${student.pointHistory}]]*/ []; 
        /*]]>*/

        if(pointHistory && pointHistory.length > 0) {
            // Preparar dados para o gráfico (Acumulado)
            let accumulatedPoints = 0;
            const labels = [];
            const dataPoints = [];

            pointHistory.forEach(point => {
                labels.push(new Date(point.date).toLocaleDateString());
                dataPoints.push(point.totalPoints);
            });

            const ctx = document.getElementById('scoreEvolutionChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pontuação Acumulada',
                        data: dataPoints,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Auto-dismiss success alerts after 3 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const successAlert = document.querySelector('.alert-success');
            if (successAlert) {
                setTimeout(function() {
                    const bsAlert = new bootstrap.Alert(successAlert);
                    bsAlert.close();
                }, 3000);
            }
        });
    </script>
</body>
</html>